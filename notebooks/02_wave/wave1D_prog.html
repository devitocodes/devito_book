

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Implementation &#8212; The Devito Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/02_wave/wave1D_prog';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Coming soon" href="wave_placeholder.html" />
    <link rel="prev" title="Simulation of waves on a string" href="wave1D_fd1.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/devito_logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/devito_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to the Devito Book!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Vibration ODEs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_vib/vib_undamped.html">Finite difference discretization</a></li>








<li class="toctree-l1"><a class="reference internal" href="../01_vib/vib_placeholder.html">Coming soon</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Wave equations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="wave1D_fd1.html">Simulation of waves on a string</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Implementation</a></li>

<li class="toctree-l1"><a class="reference internal" href="wave_placeholder.html">Coming soon</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Diffusion equations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../03_diffu/diffu_rw.html">Random walk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_diffu/diffu_placeholder.html">Coming soon</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advection equations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_advec/advec.html">One-dimensional time-dependent advection equations</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Nonlinear problems</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_nonlin/nonlin_placeholder.html">Coming soon</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/devitocodes/devito_book" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/02_wave/wave1D_prog.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Implementation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#callback-function-for-user-specific-actions">Callback function for user-specific actions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-solver-function">The solver function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verification-exact-quadratic-solution">Verification: exact quadratic solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verification-convergence-rates">Verification: convergence rates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-animating-the-solution">Visualization: animating the solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-for-administering-the-simulation">Function for administering the simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dissection-of-the-code">Dissection of the code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-movie-files">Making movie files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#skipping-frames-for-animation-speed">Skipping frames for animation speed</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-case">Running a case</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-a-scaled-pde-model">Working with a scaled PDE model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-simulate-a-standing-wave">Exercise 1: Simulate a standing wave</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">Remarks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-add-storage-of-solution-in-a-user-action-function">Exercise 2: Add storage of solution in a user action function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-use-a-class-for-the-user-action-function">Exercise 3: Use a class for the user action function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-compare-several-courant-numbers-in-one-movie">Exercise 4: Compare several Courant numbers in one movie</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-implementing-the-solver-function-as-a-generator">Exercise 5: Implementing the solver function as a generator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-6-calculus-with-1d-mesh-functions">Project 6: Calculus with 1D mesh functions</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h1>
<div id="wave:pde1:impl"></div>
<p>This section presents the complete computational algorithm, its
implementation in Python code, animation of the solution, and
verification of the implementation.</p>
<p>A real implementation of the basic computational algorithm from
the sections <span class="xref myst">Formulating a recursive algorithm</span> and <span class="xref myst">Sketch of an implementation</span> can be
encapsulated in a function, taking all the input data for the problem
as arguments.  The physical input data consists of <span class="math notranslate nohighlight">\(c\)</span>, <span class="math notranslate nohighlight">\(I(x)\)</span>,
<span class="math notranslate nohighlight">\(V(x)\)</span>, <span class="math notranslate nohighlight">\(f(x,t)\)</span>, <span class="math notranslate nohighlight">\(L\)</span>, and <span class="math notranslate nohighlight">\(T\)</span>.  The numerical input is the mesh
parameters <span class="math notranslate nohighlight">\(\Delta t\)</span> and <span class="math notranslate nohighlight">\(\Delta x\)</span>.</p>
<p>Instead of specifying <span class="math notranslate nohighlight">\(\Delta t\)</span> <em>and</em> <span class="math notranslate nohighlight">\(\Delta x\)</span>, we can specify one
of them and the Courant number <span class="math notranslate nohighlight">\(C\)</span> instead, since having explicit
control of the Courant number is convenient when investigating the
numerical method. Many find it natural to prescribe the resolution of
the spatial grid and set <span class="math notranslate nohighlight">\(N_x\)</span>. The solver function can then compute
<span class="math notranslate nohighlight">\(\Delta t = CL/(cN_x)\)</span>. However, for comparing <span class="math notranslate nohighlight">\(u(x,t)\)</span> curves (as
functions of <span class="math notranslate nohighlight">\(x\)</span>) for various Courant numbers
it is more convenient to keep <span class="math notranslate nohighlight">\(\Delta t\)</span> fixed for
all <span class="math notranslate nohighlight">\(C\)</span> and let <span class="math notranslate nohighlight">\(\Delta x\)</span> vary according to <span class="math notranslate nohighlight">\(\Delta x = c\Delta t/C\)</span>.
With <span class="math notranslate nohighlight">\(\Delta t\)</span> fixed, all frames correspond to the same time <span class="math notranslate nohighlight">\(t\)</span>,
and this simplifies animations that compare simulations with different
mesh resolutions. Plotting functions of <span class="math notranslate nohighlight">\(x\)</span>
with different spatial resolution is trivial,
so it is easier to let <span class="math notranslate nohighlight">\(\Delta x\)</span> vary in the simulations than <span class="math notranslate nohighlight">\(\Delta t\)</span>.</p>
<section id="callback-function-for-user-specific-actions">
<h2>Callback function for user-specific actions<a class="headerlink" href="#callback-function-for-user-specific-actions" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:impl:useraction"></div>
<p>The solution at all spatial points at a new time level is stored in an
array <code class="docutils literal notranslate"><span class="pre">u</span></code> of length <span class="math notranslate nohighlight">\(N_x+1\)</span>. We need to decide what to do with
this solution, e.g., visualize the curve, analyze the values, or write
the array to file for later use. The decision about what to do is left to
the user in the form of a user-supplied function
<code class="docutils literal notranslate"><span class="pre">user_action(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></code>, where <code class="docutils literal notranslate"><span class="pre">u</span></code> is the solution at the spatial points <code class="docutils literal notranslate"><span class="pre">x</span></code> at time <code class="docutils literal notranslate"><span class="pre">t[n]</span></code>.
The <code class="docutils literal notranslate"><span class="pre">user_action</span></code> function is called from the solver at each time level <code class="docutils literal notranslate"><span class="pre">n</span></code>.</p>
<p>If the user wants to plot the solution or store the solution at a
time point, she needs to write such a function and take appropriate
actions inside it. We will show examples on many such <code class="docutils literal notranslate"><span class="pre">user_action</span></code>
functions.</p>
<p>Since the solver function makes calls back to the user’s code
via such a function, this type of function is called a <em>callback function</em>.
When writing general software, like our solver function, which also needs
to carry out special problem- or solution-dependent actions
(like visualization),
it is a common technique to leave those actions to user-supplied
callback functions.</p>
<p>The callback function can be used to terminate the solution process
if the user returns <code class="docutils literal notranslate"><span class="pre">True</span></code>. For example,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_user_action_function</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<p>is a callback function that will terminate the solver function (given below) of the
amplitude of the waves exceed 10, which is here considered as a numerical
instability.</p>
</section>
<section id="the-solver-function">
<h2>The solver function<a class="headerlink" href="#the-solver-function" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:impl:solver"></div>
<p>A first attempt at a solver function is listed below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NBVAL_IGNORE_OUTPUT</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">devito</span> <span class="kn">import</span> <span class="n">Constant</span><span class="p">,</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">TimeFunction</span><span class="p">,</span> <span class="n">SparseTimeFunction</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">Eq</span><span class="p">,</span> <span class="n">solve</span><span class="p">,</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">Buffer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s solver, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve u_tt=c^2*u_xx + f on (0,L)x(0,T].&quot;&quot;&quot;</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Mesh points in time</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Mesh points in space</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>                         <span class="c1"># Help variable in the scheme</span>
    
    <span class="c1"># Make sure dx and dt are compatible with x and t</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Initialising functions f and V if not provided</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>
        
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># Measure CPU time</span>

    <span class="c1"># Set up grid</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
    <span class="n">t_s</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">stepping_dim</span>
        
    <span class="c1"># Create and initialise u</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">TimeFunction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">time_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">space_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">u</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">[:])</span>

    <span class="n">x_dim</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t_dim</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_dim</span>
    
    <span class="c1"># The wave equation we are trying to solve</span>
    <span class="n">pde</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dt2</span><span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">dx2</span>
    
    <span class="c1"># Source term and injection into equation</span>
    <span class="n">dt_symbolic</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_dim</span><span class="o">.</span><span class="n">spacing</span>    
    <span class="n">src</span> <span class="o">=</span> <span class="n">SparseTimeFunction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">npoint</span><span class="o">=</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span>
        <span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">src</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">src_term</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">src</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt_symbolic</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">stencil</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span> <span class="n">solve</span><span class="p">(</span><span class="n">pde</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">forward</span><span class="p">))</span>

    <span class="c1"># Set up special stencil for initial timestep with substitution for u.backward</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">npoint</span><span class="o">=</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">[:])</span>
    <span class="n">stencil_init</span> <span class="o">=</span> <span class="n">stencil</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">backward</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">forward</span> <span class="o">-</span> <span class="n">dt_symbolic</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># Boundary conditions</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Eq</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">t_s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">bc</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Eq</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">t_s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">],</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># Create and apply operators</span>
    <span class="n">op_init</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">([</span><span class="n">stencil_init</span><span class="p">]</span><span class="o">+</span><span class="n">src_term</span><span class="o">+</span><span class="n">bc</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">([</span><span class="n">stencil</span><span class="p">]</span><span class="o">+</span><span class="n">src_term</span><span class="o">+</span><span class="n">bc</span><span class="p">)</span>
    
    <span class="n">op_init</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">time_M</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">time_m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_M</span><span class="o">=</span><span class="n">Nt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    
    <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    
    <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span>
</pre></div>
</div>
</div>
</div>
<p>A couple of remarks about the above code is perhaps necessary:</p>
<ul class="simple">
<li><p>Although we give <code class="docutils literal notranslate"><span class="pre">dt</span></code> and compute <code class="docutils literal notranslate"><span class="pre">dx</span></code> via <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code>, the resulting
<code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span></code> meshes do not necessarily correspond exactly to these values
because of rounding errors. To explicitly ensure that <code class="docutils literal notranslate"><span class="pre">dx</span></code> and <code class="docutils literal notranslate"><span class="pre">dt</span></code>
correspond to the cell sizes in <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">t</span></code>, we recompute the values.</p></li>
<li><p>According to the particular choice made in the section <span class="xref myst">Callback function for user-specific actions</span>, a true value returned from <code class="docutils literal notranslate"><span class="pre">user_action</span></code> should terminate the simulation.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NBVAL_IGNORE_OUTPUT</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span>

<span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operator `Kernel` ran in 0.01 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operator `Kernel` ran in 0.01 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.9.17/x64/lib/python3.9/site-packages/numpy/core/getlimits.py:549: UserWarning: The value of the smallest subnormal for &lt;class &#39;numpy.float64&#39;&gt; type is zero.
  setattr(self, word, getattr(machar, word).flat[0])
/opt/hostedtoolcache/Python/3.9.17/x64/lib/python3.9/site-packages/numpy/core/getlimits.py:89: UserWarning: The value of the smallest subnormal for &lt;class &#39;numpy.float64&#39;&gt; type is zero.
  return self._float_to_str(self.smallest_subnormal)
No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
</pre></div>
</div>
<img alt="../../_images/fa5cd3de9cca7f658e35eb150fdce2ed7c968b97b32329c3e5a7fe156af2807b.png" src="../../_images/fa5cd3de9cca7f658e35eb150fdce2ed7c968b97b32329c3e5a7fe156af2807b.png" />
</div>
</div>
</section>
<section id="verification-exact-quadratic-solution">
<h2>Verification: exact quadratic solution<a class="headerlink" href="#verification-exact-quadratic-solution" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:impl:verify:quadratic"></div>
<p>We use the test problem derived in the section <span class="xref myst">A slightly generalized model problem</span> for
verification. Below is a unit test based on this test problem
and realized as a proper <em>test function</em> compatible with the unit test
frameworks nose or pytest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s test_quadratic, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">test_quadratic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that u(x,t)=x(L-x)(1+t/2) is exactly reproduced.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Very coarse mesh for this exact test</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">def</span> <span class="nf">assert_no_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-7</span>
        <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When this function resides in the file <a class="reference external" href="https://github.com/devitocodes/devito_book/blob/master/fdm-devito-notebooks/02_wave/src-wave/wave1D/wave1D_u0.py"><code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code></a>, one can run
pytest to check that all test functions with names <code class="docutils literal notranslate"><span class="pre">test_*()</span></code>
in this file work:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Terminal&gt; py.test -s -v wave1D_u0.py
</pre></div>
</div>
</section>
<section id="verification-convergence-rates">
<h2>Verification: convergence rates<a class="headerlink" href="#verification-convergence-rates" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:impl:verify:rate"></div>
<p>A more general method, but not so reliable as a verification method,
is to compute the convergence rates and see if they coincide with
theoretical estimates. Here we expect a rate of 2 according to
the various results in the section <span class="xref myst">Analysis of the difference equations
</span>.
A general function for computing convergence rates can be written like
this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s convergence_rates, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">convergence_rates</span><span class="p">(</span>
    <span class="n">u_exact</span><span class="p">,</span>                 <span class="c1"># Python function for exact solution</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span>           <span class="c1"># physical parameters</span>
    <span class="n">dt0</span><span class="p">,</span> <span class="n">num_meshes</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>  <span class="c1"># numerical parameters</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Half the time step and estimate convergence rates for</span>
<span class="sd">    for num_meshes simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First define an appropriate user action function</span>
    <span class="k">global</span> <span class="n">error</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># error computed in the user action function</span>

    <span class="k">def</span> <span class="nf">compute_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">error</span>  <span class="c1"># must be global to be altered here</span>
        <span class="c1"># (otherwise error is a local variable, different</span>
        <span class="c1"># from error defined in the parent function)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Run finer and finer resolutions and compute true errors</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># dt, devito_solver adjusts dx such that C=dt*c/dx</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_meshes</span><span class="p">):</span>
        <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
               <span class="n">user_action</span><span class="o">=</span><span class="n">compute_error</span><span class="p">)</span>
        <span class="c1"># error is computed in the final call to compute_error</span>
        <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">/=</span> <span class="mi">2</span>  <span class="c1"># halve the time step for next simulation</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;h:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="c1"># Convergence rates for two consecutive experiments</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_meshes</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>
</div>
</div>
</div>
<p>Using the analytical solution from the section <span class="xref myst">Using an analytical solution of physical significance</span>, we can call <code class="docutils literal notranslate"><span class="pre">convergence_rates</span></code> to
see if we get a convergence rate that approaches 2 and use the final
estimate of the rate in an <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement such that this function becomes
a proper test function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s test_convrate_sincos, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">test_convrate_sincos</span><span class="p">():</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">u_exact</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">L</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">L</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">convergence_rates</span><span class="p">(</span>
        <span class="n">u_exact</span><span class="o">=</span><span class="n">u_exact</span><span class="p">,</span>
        <span class="n">I</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">V</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
        <span class="n">dt0</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">num_meshes</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">C</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rates sin(x)*cos(t) solution:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.002</span>
</pre></div>
</div>
</div>
</div>
<p>Doing <code class="docutils literal notranslate"><span class="pre">py.test</span> <span class="pre">-s</span> <span class="pre">-v</span> <span class="pre">wave1D_u0.py</span></code> will run also this test function and
show the rates 2.05, 1.98, 2.00, 2.00, and 2.00 (to two decimals).</p>
</section>
<section id="visualization-animating-the-solution">
<h2>Visualization: animating the solution<a class="headerlink" href="#visualization-animating-the-solution" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:impl:animate"></div>
<p>Now that we have verified the implementation it is time to do a
real computation where we also display evolution of the waves
on the screen. Since the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function knows nothing about
what type of visualizations we may want, it calls the callback function
<code class="docutils literal notranslate"><span class="pre">user_action(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></code>. We must therefore write this function and
find the proper statements for plotting the solution.</p>
<section id="function-for-administering-the-simulation">
<h3>Function for administering the simulation<a class="headerlink" href="#function-for-administering-the-simulation" title="Permalink to this heading">#</a></h3>
<p>The following <code class="docutils literal notranslate"><span class="pre">viz</span></code> function</p>
<ol class="arabic simple">
<li><p>defines a <code class="docutils literal notranslate"><span class="pre">user_action</span></code> callback function
for plotting the solution at each time level,</p></li>
<li><p>calls the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function, and</p></li>
<li><p>combines all the plots (in files) to video in different formats.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s viz, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">devito_solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run devito_solver and visualize u at each time level.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">plot_u_st</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;user_action function for devito_solver.&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                 <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Let the initial condition stay on the screen for 2</span>
        <span class="c1"># seconds, else insert a pause of 0.2 s between each plot</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;frame_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">class</span> <span class="nc">PlotMatplotlib</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for devito_solver.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotMatplotlib</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scitools.std</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># scitools.easyviz interface</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">plot_u_st</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Call devito_solver and do the simulaton</span>
    <span class="n">user_action</span> <span class="o">=</span> <span class="n">plot_u</span> <span class="k">if</span> <span class="n">animate</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">devito_solver_function</span><span class="p">(</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="p">)</span>

    <span class="c1"># Make video files</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">,</span> <span class="n">libx264</span><span class="o">=</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">libvpx</span><span class="o">=</span><span class="s1">&#39;webm&#39;</span><span class="p">,</span>
                     <span class="n">libtheora</span><span class="o">=</span><span class="s1">&#39;ogg&#39;</span><span class="p">)</span>  <span class="c1"># video formats</span>
    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> movie.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="c1"># Make an HTML play for showing the animation in a browser</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">movie</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                  <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;movie.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dissection-of-the-code">
<h3>Dissection of the code<a class="headerlink" href="#dissection-of-the-code" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">viz</span></code> function can either use SciTools or Matplotlib for
visualizing the solution. The <code class="docutils literal notranslate"><span class="pre">user_action</span></code> function based on SciTools
is called <code class="docutils literal notranslate"><span class="pre">plot_u_st</span></code>, while the <code class="docutils literal notranslate"><span class="pre">user_action</span></code> function based on
Matplotlib is a bit more complicated as it is realized as a class and
needs statements that differ from those for making static plots.
SciTools can utilize both Matplotlib and Gnuplot (and many other
plotting programs) for doing the graphics, but Gnuplot is a relevant
choice for large <span class="math notranslate nohighlight">\(N_x\)</span> or in two-dimensional problems
as Gnuplot is significantly faster than
Matplotlib for screen animations.</p>
<p>A function inside another function, like <code class="docutils literal notranslate"><span class="pre">plot_u_st</span></code> in the above code
segment, has access to <em>and remembers</em> all the local variables in the
surrounding code inside the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function (!). This is known in
computer science as a <em>closure</em> and is very convenient to program
with. For example, the <code class="docutils literal notranslate"><span class="pre">plt</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code> modules defined outside
<code class="docutils literal notranslate"><span class="pre">plot_u</span></code> are accessible for <code class="docutils literal notranslate"><span class="pre">plot_u_st</span></code> when the function is called
(as <code class="docutils literal notranslate"><span class="pre">user_action</span></code>) in the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function.  Some may think, however,
that a class instead of a closure is a cleaner and
easier-to-understand implementation of the user action function, see
the section <span class="xref myst">Building a general 1D wave equation solver</span>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">plot_u_st</span></code> function just makes a standard SciTools <code class="docutils literal notranslate"><span class="pre">plot</span></code> command
for plotting <code class="docutils literal notranslate"><span class="pre">u</span></code> as a function of <code class="docutils literal notranslate"><span class="pre">x</span></code> at time <code class="docutils literal notranslate"><span class="pre">t[n]</span></code>.  To achieve a
smooth animation, the <code class="docutils literal notranslate"><span class="pre">plot</span></code> command should take keyword arguments
instead of being broken into separate calls to <code class="docutils literal notranslate"><span class="pre">xlabel</span></code>, <code class="docutils literal notranslate"><span class="pre">ylabel</span></code>,
<code class="docutils literal notranslate"><span class="pre">axis</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, and <code class="docutils literal notranslate"><span class="pre">show</span></code>.  Several <code class="docutils literal notranslate"><span class="pre">plot</span></code> calls will automatically
cause an animation on the screen. In addition, we want to save each
frame in the animation to file. We then need a filename where the
frame number is padded with zeros, here <code class="docutils literal notranslate"><span class="pre">tmp_0000.png</span></code>,
<code class="docutils literal notranslate"><span class="pre">tmp_0001.png</span></code>, and so on.  The proper printf construction is then
<code class="docutils literal notranslate"><span class="pre">tmp_%04d.png</span></code>. The section <span class="xref myst">Making animations</span> contains more basic
information on making animations.</p>
<p>The solver is called with an argument <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> as <code class="docutils literal notranslate"><span class="pre">user_function</span></code>.
If the user chooses to use SciTools, <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> is the <code class="docutils literal notranslate"><span class="pre">plot_u_st</span></code>
callback function, but for Matplotlib it is an instance of the
class <code class="docutils literal notranslate"><span class="pre">PlotMatplotlib</span></code>. Also this class makes use of variables
defined in the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function: <code class="docutils literal notranslate"><span class="pre">plt</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code>.
With Matplotlib, one has to make the first plot the standard way, and
then update the <span class="math notranslate nohighlight">\(y\)</span> data in the plot at every time level. The update
requires active use of the returned value from <code class="docutils literal notranslate"><span class="pre">plt.plot</span></code> in the first
plot.  This value would need to be stored in a local variable if we
were to use a closure for the <code class="docutils literal notranslate"><span class="pre">user_action</span></code> function when doing the
animation with Matplotlib. mathcal{I}_t is much easier to store the
variable as a class attribute <code class="docutils literal notranslate"><span class="pre">self.lines</span></code>. Since the class is essentially a
function, we implement the function as the special method <code class="docutils literal notranslate"><span class="pre">__call__</span></code>
such that the instance <code class="docutils literal notranslate"><span class="pre">plot_u(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></code> can be called as a standard
callback function from <code class="docutils literal notranslate"><span class="pre">solver</span></code>.</p>
</section>
<section id="making-movie-files">
<h3>Making movie files<a class="headerlink" href="#making-movie-files" title="Permalink to this heading">#</a></h3>
<p>From the
<code class="docutils literal notranslate"><span class="pre">frame_*.png</span></code> files containing the frames in the animation we can
make video files.</p>
<p>the section <span class="xref myst">vib:ode1:anim</span> presents basic information on how to
use the <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code> program for producing video files
in different modern formats: Flash, MP4, Webm, and Ogg.</p>
<p>We use the <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code> program to combine individual
plot files to movies in modern formats: Flash, MP4, Webm, and Ogg.
A typical <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code> command for creating a movie file
in Ogg format
with 4 frames per second built from a collection of
plot files with names generated by <code class="docutils literal notranslate"><span class="pre">frame_%04d.png</span></code>,
look like</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libtheora movie.ogg
</pre></div>
</div>
<p>The different formats require different video encoders (<code class="docutils literal notranslate"><span class="pre">-c:v</span></code>) to
be installed: Flash applies <code class="docutils literal notranslate"><span class="pre">flv</span></code>, WebM applies <code class="docutils literal notranslate"><span class="pre">libvpx</span></code>, and MP4
applies <code class="docutils literal notranslate"><span class="pre">libx264</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v flv movie.flv
    Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libvpx movie.webm
    Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libx264 movie.mp4
</pre></div>
</div>
<p>Players like <code class="docutils literal notranslate"><span class="pre">vlc</span></code>, <code class="docutils literal notranslate"><span class="pre">mplayer</span></code>, <code class="docutils literal notranslate"><span class="pre">gxine</span></code>, and <code class="docutils literal notranslate"><span class="pre">totem</span></code>
can be used to play these movie files.</p>
<p>Note that padding the frame counter with zeros in the <code class="docutils literal notranslate"><span class="pre">frame_*.png</span></code>
files, as specified by the <code class="docutils literal notranslate"><span class="pre">%04d</span></code> format, is essential so that the wildcard
notation <code class="docutils literal notranslate"><span class="pre">frame_*.png</span></code> expands to the correct set of files.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">viz</span></code> function creates an <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code> command
with the proper arguments for each of the formats Flash, MP4, WebM,
and Ogg. The task is greatly simplified by having a
<code class="docutils literal notranslate"><span class="pre">codec2ext</span></code> dictionary for mapping
video codec names to filename extensions.</p>
<p>As mentioned in the section <span class="xref myst">vib:ode1:anim</span>, only</p>
<p>Only</p>
<p>two formats are actually needed to ensure that all browsers can
successfully play the video: MP4 and WebM.</p>
<p>Some animations having a large number of plot files may not
be properly combined into a video using <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code>.
A method that always works is to play the PNG files as an animation
in a browser using JavaScript code in an HTML file.
The SciTools package has a function <code class="docutils literal notranslate"><span class="pre">movie</span></code> (or a stand-alone command
<code class="docutils literal notranslate"><span class="pre">scitools</span> <span class="pre">movie</span></code>) for creating such an HTML player. The <code class="docutils literal notranslate"><span class="pre">plt.movie</span></code>
call in the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function shows how the function is used.
The file <code class="docutils literal notranslate"><span class="pre">movie.html</span></code> can be loaded into a browser and features
a user interface where the speed of the animation can be controlled.
Note that the movie in this case consists of the <code class="docutils literal notranslate"><span class="pre">movie.html</span></code> file
and all the frame files <code class="docutils literal notranslate"><span class="pre">tmp_*.png</span></code>.</p>
</section>
<section id="skipping-frames-for-animation-speed">
<h3>Skipping frames for animation speed<a class="headerlink" href="#skipping-frames-for-animation-speed" title="Permalink to this heading">#</a></h3>
<p>Sometimes the time step is small and <span class="math notranslate nohighlight">\(T\)</span> is large, leading to an
inconveniently large number of plot files and a slow animation on the
screen. The solution to such a problem is to decide on a total number
of frames in the animation, <code class="docutils literal notranslate"><span class="pre">num_frames</span></code>, and plot the solution only for
every <code class="docutils literal notranslate"><span class="pre">skip_frame</span></code> frames. For example, setting <code class="docutils literal notranslate"><span class="pre">skip_frame=5</span></code> leads
to plots of every 5 frames. The default value <code class="docutils literal notranslate"><span class="pre">skip_frame=1</span></code> plots
every frame.
The total number of time levels (i.e., maximum
possible number of frames) is the length of <code class="docutils literal notranslate"><span class="pre">t</span></code>, <code class="docutils literal notranslate"><span class="pre">t.size</span></code> (or <code class="docutils literal notranslate"><span class="pre">len(t)</span></code>),
so if we want <code class="docutils literal notranslate"><span class="pre">num_frames</span></code> frames in the animation,
we need to plot every <code class="docutils literal notranslate"><span class="pre">t.size/num_frames</span></code> frames:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_u</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">skip_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_frames</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">skip_frame</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The initial condition (<code class="docutils literal notranslate"><span class="pre">n=0</span></code>) is included by <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span> <span class="pre">==</span> <span class="pre">0</span></code>,
as well as every <code class="docutils literal notranslate"><span class="pre">skip_frame</span></code>-th frame.
As <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span> <span class="pre">==</span> <span class="pre">0</span></code> will very seldom be true for the
very final frame, we must also check if <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">==</span> <span class="pre">t.size-1</span></code> to
get the final frame included.</p>
<p>A simple choice of numbers may illustrate the formulas: say we have
801 frames in total (<code class="docutils literal notranslate"><span class="pre">t.size</span></code>) and we allow only 60 frames to be
plotted. As <code class="docutils literal notranslate"><span class="pre">n</span></code> then runs from 801 to 0, we need to plot every 801/60
frame, which with integer division yields 13 as <code class="docutils literal notranslate"><span class="pre">skip_frame</span></code>. Using
the mod function, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span></code>, this operation is zero every time
<code class="docutils literal notranslate"><span class="pre">n</span></code> can be divided by 13 without a remainder. That is, the <code class="docutils literal notranslate"><span class="pre">if</span></code> test
is true when <code class="docutils literal notranslate"><span class="pre">n</span></code> equals <span class="math notranslate nohighlight">\(0, 13, 26, 39, ..., 780, 801\)</span>. The associated
code is included in the <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> function, inside the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function,
in the file <a class="reference external" href="https://github.com/devitocodes/devito_book/blob/master/fdm-devito-notebooks/02_wave/src-wave/wave1D/wave1D_u0.py"><code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code></a>.</p>
</section>
</section>
<section id="running-a-case">
<h2>Running a case<a class="headerlink" href="#running-a-case" title="Permalink to this heading">#</a></h2>
<div id="wave:pde1:guitar:data"></div>
<p>The first demo of our 1D wave equation solver concerns vibrations of a
string that is initially deformed to a triangular shape, like when picking
a guitar string:</p>
<!-- Equation labels as ordinary links -->
<div id="wave:pde1:guitar:I"></div>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{equation}
I(x) = \left\lbrace
\begin{array}{ll}
ax/x_0, &amp; x &lt; x_0,\\ 
a(L-x)/(L-x_0), &amp; \hbox{otherwise}
\end{array}\right.
\label{wave:pde1:guitar:I} \tag{1}
\end{equation}
\end{split}\]</div>
<p>We choose <span class="math notranslate nohighlight">\(L=75\)</span> cm, <span class="math notranslate nohighlight">\(x_0=0.8L\)</span>, <span class="math notranslate nohighlight">\(a=5\)</span> mm, and a time frequency
<span class="math notranslate nohighlight">\(\nu = 440\)</span> Hz. The relation between the wave speed <span class="math notranslate nohighlight">\(c\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span> is
<span class="math notranslate nohighlight">\(c=\nu\lambda\)</span>, where <span class="math notranslate nohighlight">\(\lambda\)</span> is the wavelength, taken as <span class="math notranslate nohighlight">\(2L\)</span> because
the longest wave on the string forms frac{1}{2} a wavelength. There is no
external force, so <span class="math notranslate nohighlight">\(f=0\)</span> (meaning we can neglect gravity),
and the string is at rest initially, implying <span class="math notranslate nohighlight">\(V=0\)</span>.</p>
<p>Regarding numerical parameters, we need to specify a <span class="math notranslate nohighlight">\(\Delta t\)</span>.
Sometimes it is more natural to think of a spatial resolution instead
of a time step. A natural semi-coarse spatial resolution in the present
problem is <span class="math notranslate nohighlight">\(N_x=50\)</span>. We can then choose the associated <span class="math notranslate nohighlight">\(\Delta t\)</span> (as required
by the <code class="docutils literal notranslate"><span class="pre">viz</span></code> and <code class="docutils literal notranslate"><span class="pre">solver</span></code> functions) as the stability limit:
<span class="math notranslate nohighlight">\(\Delta t = L/(N_xc)\)</span>. This is the <span class="math notranslate nohighlight">\(\Delta t\)</span> to be specified,
but notice that if <span class="math notranslate nohighlight">\(C&lt;1\)</span>, the actual <span class="math notranslate nohighlight">\(\Delta x\)</span> computed in <code class="docutils literal notranslate"><span class="pre">solver</span></code> gets
larger than <span class="math notranslate nohighlight">\(L/N_x\)</span>: <span class="math notranslate nohighlight">\(\Delta x = c\Delta t/C = L/(N_xC)\)</span>. (The reason
is that we fix <span class="math notranslate nohighlight">\(\Delta t\)</span> and adjust <span class="math notranslate nohighlight">\(\Delta x\)</span>, so if <span class="math notranslate nohighlight">\(C\)</span> gets
smaller, the code implements this effect in terms of a larger <span class="math notranslate nohighlight">\(\Delta x\)</span>.)</p>
<p>A function for setting the physical and numerical parameters and
calling <code class="docutils literal notranslate"><span class="pre">viz</span></code> in this application goes as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load -s guitar, src-wave/wave1D/wave1D_u0.py</span>
<span class="k">def</span> <span class="nf">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangular wave (pulled guitar string).&quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">L</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">440</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">L</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">freq</span><span class="o">*</span><span class="n">wavelength</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span>
    <span class="n">num_periods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">omega</span><span class="o">*</span><span class="n">num_periods</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">x0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span> <span class="k">else</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="n">umin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>  <span class="n">umax</span> <span class="o">=</span> <span class="o">-</span><span class="n">umin</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
              <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;scitools&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The associated program has the name <a class="reference external" href="https://github.com/devitocodes/devito_book/blob/master/fdm-devito-notebooks/02_wave/src-wave/wave1D/wave1D_u0.py"><code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code></a>. Run
the program and watch the <a class="reference download internal" download="" href="../../_downloads/42dc8b1923a4c5c67fb8c5d680f7330b/movie.html"><span class="xref download myst">movie of the vibrating string</span></a>.
The string should ideally consist of straight segments, but these are
somewhat wavy due to numerical approximation. Run the case with the
<code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code> code and <span class="math notranslate nohighlight">\(C=1\)</span> to see the exact solution.</p>
</section>
<section id="working-with-a-scaled-pde-model">
<h2>Working with a scaled PDE model<a class="headerlink" href="#working-with-a-scaled-pde-model" title="Permalink to this heading">#</a></h2>
<p>Depending on the model, it may be a substantial job to establish
consistent and relevant physical parameter values for a case.  The
guitar string example illustrates the point.  However, by <em>scaling</em>
the mathematical problem we can often reduce the need to estimate
physical parameters dramatically. The scaling technique consists of
introducing new independent and dependent variables, with the aim that
the absolute values of these lie in <span class="math notranslate nohighlight">\([0,1]\)</span>. We introduce the
dimensionless variables (details are found in Section 3.1.1 in <span class="xref myst">[Langtangen_scaling]</span>)</p>
<div class="math notranslate nohighlight">
\[
\bar x = \frac{x}{L},\quad \bar t = \frac{c}{L}t,\quad
\bar u = \frac{u}{a}
\]</div>
<p>Here, <span class="math notranslate nohighlight">\(L\)</span> is a typical length scale, e.g., the length of the domain,
and <span class="math notranslate nohighlight">\(a\)</span> is a typical size of <span class="math notranslate nohighlight">\(u\)</span>, e.g., determined from the
initial condition: <span class="math notranslate nohighlight">\(a=\max_x|I(x)|\)</span>.</p>
<p>We get by the chain rule that</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial u}{\partial t} =
\frac{\partial}{\partial\bar t}\left(a\bar u\right)
\frac{d\bar t}{dt} =
\frac{ac}{L}\frac{\partial\bar u}{\partial\bar t}
\]</div>
<p>Similarly,</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial u}{\partial x}
= \frac{a}{L}\frac{\partial\bar u}{\partial\bar x}
\]</div>
<p>Inserting the dimensionless variables in the PDE gives, in case <span class="math notranslate nohighlight">\(f=0\)</span>,</p>
<div class="math notranslate nohighlight">
\[
\frac{a^2c^2}{L^2}\frac{\partial^2\bar u}{\partial\bar t^2}
= \frac{a^2c^2}{L^2}\frac{\partial^2\bar u}{\partial\bar x^2}
\]</div>
<p>Dropping the bars, we arrive at the scaled PDE</p>
<!-- Equation labels as ordinary links -->
<div id="_auto1"></div>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\frac{\partial^2 u}{\partial t^2} = \frac{\partial^2 u}{\partial x^2},
\quad x\in (0,1),\ t\in (0,cT/L),
\label{_auto1} \tag{2}
\end{equation}
\]</div>
<p>which has no parameter <span class="math notranslate nohighlight">\(c^2\)</span> anymore. The initial conditions are scaled
as</p>
<div class="math notranslate nohighlight">
\[
a\bar u(\bar x, 0) = I(L\bar x)
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\frac{a}{L/c}\frac{\partial\bar u}{\partial\bar t}(\bar x,0) = V(L\bar x),
\]</div>
<p>resulting in</p>
<div class="math notranslate nohighlight">
\[
\bar u(\bar x, 0) = \frac{I(L\bar x)}{\max_x |I(x)|},\quad
\frac{\partial\bar u}{\partial\bar t}(\bar x,0) = \frac{L}{ac}V(L\bar x)
\]</div>
<p>In the common case <span class="math notranslate nohighlight">\(V=0\)</span> we see that there are no physical parameters to be
estimated in the PDE model!</p>
<p>If we have a program implemented for the physical wave equation with
dimensions, we can obtain the dimensionless, scaled version by
setting <span class="math notranslate nohighlight">\(c=1\)</span>. The initial condition of a guitar string,
given in (<span class="xref myst">1</span>), gets its scaled form by choosing
<span class="math notranslate nohighlight">\(a=1\)</span>, <span class="math notranslate nohighlight">\(L=1\)</span>, and <span class="math notranslate nohighlight">\(x_0\in [0,1]\)</span>. This means that we only need to
decide on the <span class="math notranslate nohighlight">\(x_0\)</span> value as a fraction of unity, because
the scaled problem corresponds to setting all
other parameters to unity. In the code we can just set
<code class="docutils literal notranslate"><span class="pre">a=c=L=1</span></code>, <code class="docutils literal notranslate"><span class="pre">x0=0.8</span></code>, and there is no need to calculate with
wavelengths and frequencies to estimate <span class="math notranslate nohighlight">\(c\)</span>!</p>
<p>The only non-trivial parameter to estimate in the scaled problem
is the final end time of the simulation, or more precisely, how it relates
to periods in periodic solutions in time, since we often want to
express the end time as a certain number of periods.
The period in the dimensionless problem is 2, so the end time can be
set to the desired number of periods times 2.</p>
<p>Why the dimensionless period is 2 can be explained by the following
reasoning.
Suppose that <span class="math notranslate nohighlight">\(u\)</span> behaves as <span class="math notranslate nohighlight">\(\cos (\omega t)\)</span> in time in the original
problem with dimensions. The corresponding period is then <span class="math notranslate nohighlight">\(P=2\pi/\omega\)</span>, but
we need to estimate <span class="math notranslate nohighlight">\(\omega\)</span>. A typical solution of the wave
equation is <span class="math notranslate nohighlight">\(u(x,t)=A\cos(kx)\cos(\omega t)\)</span>, where <span class="math notranslate nohighlight">\(A\)</span> is an amplitude
and <span class="math notranslate nohighlight">\(k\)</span> is related to the wave length <span class="math notranslate nohighlight">\(\lambda\)</span> in space: <span class="math notranslate nohighlight">\(\lambda = 2\pi/k\)</span>.
Both <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(A\)</span> will be given by the initial condition <span class="math notranslate nohighlight">\(I(x)\)</span>.
Inserting this <span class="math notranslate nohighlight">\(u(x,t)\)</span> in the PDE yields <span class="math notranslate nohighlight">\(-\omega^2 = -c^2k^2\)</span>, i.e.,
<span class="math notranslate nohighlight">\(\omega = kc\)</span>. The period is therefore <span class="math notranslate nohighlight">\(P=2\pi/(kc)\)</span>.
If the boundary conditions are <span class="math notranslate nohighlight">\(u(0,t)=u(L,t)\)</span>, we need to have
<span class="math notranslate nohighlight">\(kL = n\pi\)</span> for integer <span class="math notranslate nohighlight">\(n\)</span>. The period becomes <span class="math notranslate nohighlight">\(P=2L/nc\)</span>. The longest
period is <span class="math notranslate nohighlight">\(P=2L/c\)</span>. The dimensionless period <span class="math notranslate nohighlight">\(\tilde P\)</span> is obtained
by dividing <span class="math notranslate nohighlight">\(P\)</span> by the time scale <span class="math notranslate nohighlight">\(L/c\)</span>, which results in <span class="math notranslate nohighlight">\(\tilde P=2\)</span>.
Shorter waves in the initial condition will have a dimensionless
shorter period <span class="math notranslate nohighlight">\(\tilde P=2/n\)</span> (<span class="math notranslate nohighlight">\(n&gt;1\)</span>).</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exercises">
<h1>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h1>
<!-- --- begin exercise --- -->
<section id="exercise-1-simulate-a-standing-wave">
<h2>Exercise 1: Simulate a standing wave<a class="headerlink" href="#exercise-1-simulate-a-standing-wave" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:standingwave"></div>
<p>The purpose of this exercise is to simulate standing waves on <span class="math notranslate nohighlight">\([0,L]\)</span>
and illustrate the error in the simulation.
Standing waves arise from an initial condition</p>
<div class="math notranslate nohighlight">
\[
u(x,0)= A \sin\left(\frac{\pi}{L}mx\right),
\]</div>
<p>where <span class="math notranslate nohighlight">\(m\)</span> is an integer and <span class="math notranslate nohighlight">\(A\)</span> is a freely chosen amplitude.
The corresponding exact solution can be computed and reads</p>
<div class="math notranslate nohighlight">
\[
u(x,t) =  A\sin\left(\frac{\pi}{L}mx\right)
\cos\left(\frac{\pi}{L}mct\right)
\]</div>
<p><strong>a)</strong>
Explain that for a function <span class="math notranslate nohighlight">\(\sin kx\cos \omega t\)</span> the wave length
in space is <span class="math notranslate nohighlight">\(\lambda = 2\pi /k\)</span> and the period in time is <span class="math notranslate nohighlight">\(P=2\pi/\omega\)</span>.
Use these expressions to find the wave length in space and period in
time of <span class="math notranslate nohighlight">\(u\)</span> above.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
Since the sin and cos functions depend on <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(t\)</span>, respectively,
the sin function will run through one period as <span class="math notranslate nohighlight">\(x\)</span> increases by <span class="math notranslate nohighlight">\(\frac{2\pi}{k}\)</span>, while the cos function starts repeating as <span class="math notranslate nohighlight">\(t\)</span> increases by <span class="math notranslate nohighlight">\(\frac{2\pi}{\omega}\)</span>.</p>
<p>The wave length in space becomes</p>
<div class="math notranslate nohighlight">
\[
\lambda =  \frac{2\pi}{\frac{\pi}{L}m} = \frac{2L}{m}
\]</div>
<p>The period in time becomes</p>
<div class="math notranslate nohighlight">
\[
P =  \frac{2\pi}{\frac{\pi}{L}mc} = \frac{2L}{mc}
\]</div>
<!-- --- end solution of exercise --- -->
<p><strong>b)</strong>
Import the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function from <code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code> into a new file
where the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function is reimplemented such that it
plots either the numerical <em>and</em> the exact solution, <em>or</em> the error.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
See code below.</p>
<!-- --- end solution of exercise --- -->
<p><strong>c)</strong>
Make animations where you illustrate how the error
<span class="math notranslate nohighlight">\(e^n_i =u(x_i, t_n)- u^n_i\)</span>
develops and increases in time. Also make animations of
<span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(u\)</span> simultaneously.</p>
<!-- --- begin hint in exercise --- -->
<p><strong>Hint 1.</strong>
Quite long time simulations are needed in order to display significant
discrepancies between the numerical and exact solution.</p>
<!-- --- end hint in exercise --- -->
<!-- --- begin hint in exercise --- -->
<p><strong>Hint 2.</strong>
A possible set of parameters is <span class="math notranslate nohighlight">\(L=12\)</span>, <span class="math notranslate nohighlight">\(m=9\)</span>, <span class="math notranslate nohighlight">\(c=2\)</span>, <span class="math notranslate nohighlight">\(A=1\)</span>, <span class="math notranslate nohighlight">\(N_x=80\)</span>,
<span class="math notranslate nohighlight">\(C=0.8\)</span>. The error mesh function <span class="math notranslate nohighlight">\(e^n\)</span> can be simulated for 10 periods,
while 20-30 periods are needed to show significant differences between
the curves for the numerical and exact solution.</p>
<!-- --- end hint in exercise --- -->
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
The code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;src-wave/wave1D&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">wave1D_u0</span> <span class="kn">import</span> <span class="n">devito_solver</span>
<span class="c1">#from wave1D_u0v import devito_solver  # allows faster vectorized operations</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">ymax</span><span class="p">,</span>                      <span class="c1"># y axis: [-ymax, ymax]</span>
        <span class="n">u_exact</span><span class="p">,</span>                   <span class="c1"># u_exact(x, t)</span>
        <span class="n">animate</span><span class="o">=</span><span class="s1">&#39;u and u_exact&#39;</span><span class="p">,</span>   <span class="c1"># or &#39;error&#39;</span>
        <span class="n">movie_filename</span><span class="o">=</span><span class="s1">&#39;movie&#39;</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run devito_solver and visualize u at each time level.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="k">class</span> <span class="nc">Plot</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">frame_name</span><span class="o">=</span><span class="s1">&#39;frame&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># hold max amplitude errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_error_t</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># time points corresp. to max_error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_name</span> <span class="o">=</span> <span class="n">frame_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for devito_solver.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">animate</span> <span class="o">==</span> <span class="s1">&#39;u and u_exact&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                         <span class="n">x</span><span class="p">,</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span>
                         <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                         <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">],</span>
                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">-</span> <span class="n">u</span>
                <span class="n">local_max_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="c1"># self.max_error holds the increasing amplitude error</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> \
                       <span class="n">local_max_error</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_error</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_max_error</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_error_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="c1"># Use user&#39;s ymax until the error exceeds that value.</span>
                <span class="c1"># This gives a growing max value of the yaxis (but</span>
                <span class="c1"># never shrinking)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_error</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                         <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                         <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">],</span>
                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_name</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;frame_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">devito_solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">plot</span><span class="p">)</span>

    <span class="c1"># Make plot of max error versus time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot</span><span class="o">.</span><span class="n">max_error_t</span><span class="p">,</span> <span class="n">plot</span><span class="o">.</span><span class="n">max_error</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;max abs(error)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;error.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;error.pdf&#39;</span><span class="p">)</span>

    <span class="c1"># Make .flv movie file</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">)</span> <span class="c1">#, libx64=&#39;mp4&#39;, </span>
                                <span class="c1">#libvpx=&#39;webm&#39;, libtheora=&#39;ogg&#39;)</span>

    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;frame_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> </span><span class="si">%(movie_filename)s</span><span class="s1">.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">simulations</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># length of domain</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">9</span>   <span class="c1"># 2L/m: wave length or period in space (2*pi/k, k=pi*m/L)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1"># wave velocity</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># amplitude</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="n">L</span><span class="p">)</span>  <span class="c1"># 1 period in time</span>
    <span class="c1">#T = 10*P</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>   

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">L</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="mf">10.5</span><span class="o">*</span><span class="n">P</span><span class="p">,</span>
        <span class="mf">0.1</span><span class="p">,</span> <span class="n">u_exact</span><span class="p">,</span>
        <span class="n">animate</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="n">movie_filename</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="c1"># Very long simulation to demonstrate different curves</span>
    <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">P</span><span class="p">,</span>
        <span class="mf">1.2</span><span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="n">u_exact</span><span class="p">,</span>
        <span class="n">animate</span><span class="o">=</span><span class="s1">&#39;u and u_exact&#39;</span><span class="p">,</span>
        <span class="n">movie_filename</span><span class="o">=</span><span class="s1">&#39;solution&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">simulations</span><span class="p">()</span>
</pre></div>
</div>
<!-- --- end solution of exercise --- -->
<p>Filename: <code class="docutils literal notranslate"><span class="pre">wave_standing</span></code>.</p>
<!-- Closing remarks for this Exercise -->
<section id="remarks">
<h3>Remarks<a class="headerlink" href="#remarks" title="Permalink to this heading">#</a></h3>
<p>The important
parameters for numerical quality are <span class="math notranslate nohighlight">\(C\)</span> and <span class="math notranslate nohighlight">\(k\Delta x\)</span>, where
<span class="math notranslate nohighlight">\(C=c\Delta t/\Delta x\)</span> is the Courant number and <span class="math notranslate nohighlight">\(k\)</span> is defined above
(<span class="math notranslate nohighlight">\(k\Delta x\)</span> is proportional to how many mesh points we have per wave length
in space, see the <span class="xref myst">Numerical dispersion relation</span> section for explanation).</p>
<!-- --- end exercise --- -->
<!-- --- begin exercise --- -->
</section>
</section>
<section id="exercise-2-add-storage-of-solution-in-a-user-action-function">
<h2>Exercise 2: Add storage of solution in a user action function<a class="headerlink" href="#exercise-2-add-storage-of-solution-in-a-user-action-function" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:store:list"></div>
<p>Extend the <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> function in the file <code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code> to also store
the solutions <code class="docutils literal notranslate"><span class="pre">u</span></code> in a list.
To this end, declare <code class="docutils literal notranslate"><span class="pre">all_u</span></code> as
an empty list in the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function, outside <code class="docutils literal notranslate"><span class="pre">plot_u</span></code>, and perform
an append operation inside the <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> function. Note that a
function, like <code class="docutils literal notranslate"><span class="pre">plot_u</span></code>, inside another function, like <code class="docutils literal notranslate"><span class="pre">viz</span></code>,
remembers all local variables in <code class="docutils literal notranslate"><span class="pre">viz</span></code> function, including <code class="docutils literal notranslate"><span class="pre">all_u</span></code>,
even when <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> is called (as <code class="docutils literal notranslate"><span class="pre">user_action</span></code>) in the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function.
Test both <code class="docutils literal notranslate"><span class="pre">all_u.append(u)</span></code> and <code class="docutils literal notranslate"><span class="pre">all_u.append(u.copy())</span></code>.
Why does one of these constructions fail to store the solution correctly?
Let the <code class="docutils literal notranslate"><span class="pre">viz</span></code> function return the <code class="docutils literal notranslate"><span class="pre">all_u</span></code> list
converted to a two-dimensional <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
We have to explicitly use a copy of u, i.e. as <code class="docutils literal notranslate"><span class="pre">all_u.append(u.copy())</span></code>, otherwise we just get a reference to <code class="docutils literal notranslate"><span class="pre">u</span></code>, which goes on changing with the computations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1D wave equation with u=0 at the boundary.</span>
<span class="sd">Simplest possible implementation.</span>

<span class="sd">The key function is::</span>

<span class="sd">  u, x, t, cpu = solver(I, V, f, c, L, dt, C, T, user_action)</span>

<span class="sd">which solves the wave equation u_tt = c**2*u_xx on (0,L) with u=0</span>
<span class="sd">on x=0,L, for t in (0,T].  Initial conditions: u=I(x), u_t=V(x).</span>

<span class="sd">T is the stop time for the simulation.</span>
<span class="sd">dt is the desired time step.</span>
<span class="sd">C is the Courant number (=c*dt/dx), which specifies dx.</span>
<span class="sd">f(x,t) is a function for the source term (can be 0 or None).</span>
<span class="sd">I and V are functions of x.</span>

<span class="sd">user_action is a function of (u, x, t, n) where the calling</span>
<span class="sd">code can add visualization, error computations, etc.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve u_tt=c^2*u_xx + f on (0,L)x(0,T].&quot;&quot;&quot;</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Mesh points in time</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Mesh points in space</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>                         <span class="c1"># Help variable in the scheme</span>
    <span class="c1"># Make sure dx and dt are compatible with x and t</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>

    <span class="n">u</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution array at new time level</span>
    <span class="n">u_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 1 time level back</span>
    <span class="n">u_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 2 time levels back</span>

    <span class="kn">import</span> <span class="nn">time</span><span class="p">;</span>  <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>  <span class="c1"># for measuring CPU time</span>

    <span class="c1"># Load initial condition into u_1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u_1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Special formula for first time step</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Switch variables before next step</span>
    <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>
        <span class="c1"># Update all inner points at time t[n+1]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">u_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="c1"># Insert boundary conditions</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="c1"># Switch variables before next step</span>
        <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span>

<span class="k">def</span> <span class="nf">test_quadratic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that u(x,t)=x(L-x)(1+t/2) is exactly reproduced.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Very coarse mesh for this exact test</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">def</span> <span class="nf">assert_no_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-13</span>
        <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_constant</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that u(x,t)=Q=0 is exactly reproduced.&quot;&quot;&quot;</span>
    <span class="n">u_const</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Require 0 because of the boundary conditions</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span> <span class="c1"># Very coarse mesh</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                          <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_const</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span>

<span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run solver, store and visualize u at each time level.&quot;&quot;&quot;</span>

    <span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">plot_u_st</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                 <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Let the initial condition stay on the screen for 2</span>
        <span class="c1"># seconds, else insert a pause of 0.2 s between each plot</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1">#plt.savefig(&#39;frame_%04d.png&#39; % n)  # for movie making</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making        </span>
        <span class="n">all_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> 

    <span class="k">class</span> <span class="nc">PlotMatplotlib</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotMatplotlib</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scitools.std</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># scitools.easyviz interface</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">plot_u_st</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Call solver and do the simulaton</span>
    <span class="n">user_action</span> <span class="o">=</span> <span class="n">plot_u</span> <span class="k">if</span> <span class="n">animate</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver_function</span><span class="p">(</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="p">)</span>

    <span class="c1"># Make video files</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">,</span> <span class="n">libx264</span><span class="o">=</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">libvpx</span><span class="o">=</span><span class="s1">&#39;webm&#39;</span><span class="p">,</span>
                     <span class="n">libtheora</span><span class="o">=</span><span class="s1">&#39;ogg&#39;</span><span class="p">)</span>  <span class="c1"># video formats</span>
    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> movie.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="c1"># Make an HTML play for showing the animation in a browser</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">movie</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                  <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;movie.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_u</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangular wave (pulled guitar string).&quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">L</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">440</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">L</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">freq</span><span class="o">*</span><span class="n">wavelength</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span>
    <span class="n">num_periods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span><span class="o">*</span><span class="n">num_periods</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">x0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span> <span class="k">else</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="n">umin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>  <span class="n">umax</span> <span class="o">=</span> <span class="o">-</span><span class="n">umin</span>
    <span class="n">cpu</span><span class="p">,</span> <span class="n">all_u</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
                 <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;scitools&#39;</span><span class="p">)</span>
    <span class="c1"># checking</span>
    <span class="c1">#for e in all_u:</span>
    <span class="c1">#    print e[int(len(all_u[1])/2)]</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#test_quadratic()</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Courant number: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="n">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</pre></div>
</div>
<!-- --- end solution of exercise --- -->
<p>Filename: <code class="docutils literal notranslate"><span class="pre">wave1D_u0_s_store</span></code>.</p>
<!-- --- end exercise --- -->
<!-- --- begin exercise --- -->
</section>
<section id="exercise-3-use-a-class-for-the-user-action-function">
<h2>Exercise 3: Use a class for the user action function<a class="headerlink" href="#exercise-3-use-a-class-for-the-user-action-function" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:store:list:class"></div>
<p>Redo <span class="xref myst">Exercise 2: Add storage of solution in a user action function</span> using a class for the user
action function. Let the <code class="docutils literal notranslate"><span class="pre">all_u</span></code> list be an attribute in this class
and implement the user action function as a method (the special method
<code class="docutils literal notranslate"><span class="pre">__call__</span></code> is a natural choice). The class versions avoid that the
user action function depends on parameters defined outside the
function (such as <code class="docutils literal notranslate"><span class="pre">all_u</span></code> in <span class="xref myst">Exercise 2: Add storage of solution in a user action function</span>).</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
Using a class, we get</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1D wave equation with u=0 at the boundary.</span>
<span class="sd">Simplest possible implementation.</span>

<span class="sd">The key function is::</span>

<span class="sd">  u, x, t, cpu = solver(I, V, f, c, L, dt, C, T, user_action)</span>

<span class="sd">which solves the wave equation u_tt = c**2*u_xx on (0,L) with u=0</span>
<span class="sd">on x=0,L, for t in (0,T].  Initial conditions: u=I(x), u_t=V(x).</span>

<span class="sd">T is the stop time for the simulation.</span>
<span class="sd">dt is the desired time step.</span>
<span class="sd">C is the Courant number (=c*dt/dx), which specifies dx.</span>
<span class="sd">f(x,t) is a function for the source term (can be 0 or None).</span>
<span class="sd">I and V are functions of x.</span>

<span class="sd">user_action is a function of (u, x, t, n) where the calling</span>
<span class="sd">code can add visualization, error computations, etc.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve u_tt=c^2*u_xx + f on (0,L)x(0,T].&quot;&quot;&quot;</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Mesh points in time</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Mesh points in space</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>                         <span class="c1"># Help variable in the scheme</span>
    <span class="c1"># Make sure dx and dt are compatible with x and t</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>

    <span class="n">u</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution array at new time level</span>
    <span class="n">u_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 1 time level back</span>
    <span class="n">u_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 2 time levels back</span>

    <span class="kn">import</span> <span class="nn">time</span><span class="p">;</span>  <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>  <span class="c1"># for measuring CPU time</span>

    <span class="c1"># Load initial condition into u_1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u_1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Special formula for first time step</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Switch variables before next step</span>
    <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>
        <span class="c1"># Update all inner points at time t[n+1]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">u_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="c1"># Insert boundary conditions</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="c1"># Switch variables before next step</span>
        <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span>

<span class="k">def</span> <span class="nf">test_quadratic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that u(x,t)=x(L-x)(1+t/2) is exactly reproduced.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Very coarse mesh for this exact test</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">def</span> <span class="nf">assert_no_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-13</span>
        <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_constant</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that u(x,t)=Q=0 is exactly reproduced.&quot;&quot;&quot;</span>
    <span class="n">u_const</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Require 0 because of the boundary conditions</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span> <span class="c1"># Very coarse mesh</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                          <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_const</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span>

<span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run solver, store and visualize u at each time level.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">PlotUst</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                     <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                     <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span>
                     <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Let the initial condition stay on the screen for 2</span>
            <span class="c1"># seconds, else insert a pause of 0.2 s between each plot</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making        </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">PlotMatplotlib</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotMatplotlib</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scitools.std</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># scitools.easyviz interface</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotUst</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Call solver and do the simulaton</span>
    <span class="n">user_action</span> <span class="o">=</span> <span class="n">plot_u</span> <span class="k">if</span> <span class="n">animate</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver_function</span><span class="p">(</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="p">)</span>

    <span class="c1"># Make video files</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">,</span> <span class="n">libx264</span><span class="o">=</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">libvpx</span><span class="o">=</span><span class="s1">&#39;webm&#39;</span><span class="p">,</span>
                     <span class="n">libtheora</span><span class="o">=</span><span class="s1">&#39;ogg&#39;</span><span class="p">)</span>  <span class="c1"># video formats</span>
    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> movie.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="c1"># Make an HTML play for showing the animation in a browser</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">movie</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                  <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;movie.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plot_u</span><span class="o">.</span><span class="n">all_u</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangular wave (pulled guitar string).&quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">L</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">440</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">L</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">freq</span><span class="o">*</span><span class="n">wavelength</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span>
    <span class="n">num_periods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span><span class="o">*</span><span class="n">num_periods</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">x0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span> <span class="k">else</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="n">umin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>  <span class="n">umax</span> <span class="o">=</span> <span class="o">-</span><span class="n">umin</span>
    <span class="n">cpu</span><span class="p">,</span> <span class="n">all_u</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
                 <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;scitools&#39;</span><span class="p">)</span>
    <span class="c1"># checking</span>
    <span class="c1">#for e in all_u:</span>
    <span class="c1">#    print e[int(len(all_u[1])/2)]</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#test_quadratic()</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Courant number: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="n">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</pre></div>
</div>
<!-- --- end solution of exercise --- -->
<p>Filename: <code class="docutils literal notranslate"><span class="pre">wave1D_u0_s2c</span></code>.</p>
<!-- --- end exercise --- -->
<!-- --- begin exercise --- -->
</section>
<section id="exercise-4-compare-several-courant-numbers-in-one-movie">
<h2>Exercise 4: Compare several Courant numbers in one movie<a class="headerlink" href="#exercise-4-compare-several-courant-numbers-in-one-movie" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:multiple:C"></div>
<p>The goal of this exercise is to make movies where several curves,
corresponding to different Courant numbers, are visualized. Write a
program that resembles <code class="docutils literal notranslate"><span class="pre">wave1D_u0_s2c.py</span></code> in <span class="xref myst">Exercise 3: Use a class for the user action function</span>, but with a <code class="docutils literal notranslate"><span class="pre">viz</span></code> function that
can take a list of <code class="docutils literal notranslate"><span class="pre">C</span></code> values as argument and create a movie with
solutions corresponding to the given <code class="docutils literal notranslate"><span class="pre">C</span></code> values. The <code class="docutils literal notranslate"><span class="pre">plot_u</span></code> function
must be changed to store the solution in an array (see <span class="xref myst">Exercise 2: Add storage of solution in a user action function</span> or <span class="xref myst">Exercise 3: Use a class for the user action function</span> for
details), <code class="docutils literal notranslate"><span class="pre">solver</span></code> must be computed for each value of the Courant
number, and finally one must run through each time step and plot all
the spatial solution curves in one figure and store it in a file.</p>
<p>The challenge in such a visualization is to ensure that the curves in
one plot correspond to the same time point. The easiest remedy is to
keep the time resolution constant and change the space resolution
to change the Courant number. Note that each spatial grid is needed for
the final plotting, so it is an option to store those grids too.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
Modifying the code to store all solutions for each <span class="math notranslate nohighlight">\(C\)</span> value and also each corresponding spatial grid (needed for final plotting), we get</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1D wave equation with u=0 at the boundary.</span>
<span class="sd">Simplest possible implementation.</span>

<span class="sd">The key function is::</span>

<span class="sd">  u, x, t, cpu = solver(I, V, f, c, L, dt, C, T, user_action)</span>

<span class="sd">which solves the wave equation u_tt = c**2*u_xx on (0,L) with u=0</span>
<span class="sd">on x=0,L, for t in (0,T].  Initial conditions: u=I(x), u_t=V(x).</span>

<span class="sd">T is the stop time for the simulation.</span>
<span class="sd">dt is the desired time step.</span>
<span class="sd">C is the Courant number (=c*dt/dx), which specifies dx.</span>
<span class="sd">f(x,t) is a function for the source term (can be 0 or None).</span>
<span class="sd">I and V are functions of x.</span>

<span class="sd">user_action is a function of (u, x, t, n) where the calling</span>
<span class="sd">code can add visualization, error computations, etc.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve u_tt=c^2*u_xx + f on (0,L)x(0,T].&quot;&quot;&quot;</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Mesh points in time</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">C</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># Mesh points in space</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>                       <span class="c1"># Help variable in the scheme</span>
    <span class="c1"># Recompute to make sure dx and dt are compatible with x and t</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>

    <span class="n">u</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution array at new time level</span>
    <span class="n">u_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 1 time level back</span>
    <span class="n">u_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 2 time levels back</span>

    <span class="kn">import</span> <span class="nn">time</span><span class="p">;</span>  <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>  <span class="c1"># for measuring CPU time</span>

    <span class="c1"># Load initial condition into u_1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u_1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Special formula for first time step</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Switch variables before next step</span>
    <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>
        <span class="c1"># Update all inner points at time t[n+1]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">u_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="c1"># Insert boundary conditions</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="c1"># Switch variables before next step</span>
        <span class="n">u_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_1</span><span class="p">;</span>  <span class="n">u_1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span>

<span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run solver, store and viz. u at each time level with all C values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">class</span> <span class="nc">PlotUst</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># need each mesh for final plots</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">T</span><span class="p">:</span> <span class="c1"># i.e., whole time interv. done for this C</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_u</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># reset to empty list</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>  <span class="c1"># all C done</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished all C. Proceed with plots...&#39;</span><span class="p">)</span>
                    <span class="c1"># note: n will here be the last index in t[n]</span>
                    <span class="k">for</span> <span class="n">n_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>      <span class="c1"># for each tn</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n_</span><span class="p">],</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span>
                                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Solutions for all </span><span class="se">\</span>
<span class="s1">                                        C at t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n_</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)):</span>
                            <span class="c1"># build plot at this tn with each </span>
                            <span class="c1"># sol. from the different C values</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> 
                                     <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">n_</span><span class="p">],</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                        <span class="c1"># Let the init. cond. stay on the screen for</span>
                        <span class="c1"># 2 sec, else insert a pause of 0.2 s  </span>
                        <span class="c1"># between each plot                        </span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                                                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>                        
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n_</span><span class="p">)</span>  <span class="c1"># for movie</span>
                

    <span class="k">class</span> <span class="nc">PlotMatplotlib</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">T</span><span class="p">:</span> <span class="c1"># i.e., whole time interv. done for this C</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_u</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_u</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># reset to empty list</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>  <span class="c1"># all C done</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished all C. Proceed with plots...&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                    <span class="c1"># note: n will here be the last index in t[n]</span>
                    <span class="k">for</span> <span class="n">n_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>      <span class="c1"># for each tn</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n_</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)):</span>
                            <span class="c1"># build plot at this tn with each </span>
                            <span class="c1"># sol. from the different C values</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_u_for_all_C</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">n_</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solutions for all </span><span class="se">\</span>
<span class="s1">                                   C at t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n_</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                        <span class="c1"># Let the init. cond. stay on the screen for</span>
                        <span class="c1"># 2 sec, else insert a pause of 0.2 s  </span>
                        <span class="c1"># between each plot                        </span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                                                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>                        
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n_</span><span class="p">)</span>  <span class="c1"># for movie</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotMatplotlib</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scitools.std</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># scitools.easyviz interface</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotUst</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Call solver and do the simulaton</span>
    <span class="n">user_action</span> <span class="o">=</span> <span class="n">plot_u</span> <span class="k">if</span> <span class="n">animate</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">C_value</span> <span class="ow">in</span> <span class="n">C</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C_value --------------------------------- &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">C_value</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver_function</span><span class="p">(</span>
                     <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C_value</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="p">)</span>

    <span class="c1"># Make video files</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">,</span> <span class="n">libx264</span><span class="o">=</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">libvpx</span><span class="o">=</span><span class="s1">&#39;webm&#39;</span><span class="p">,</span>
                     <span class="n">libtheora</span><span class="o">=</span><span class="s1">&#39;ogg&#39;</span><span class="p">)</span>  <span class="c1"># video formats</span>
    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> movie.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="c1"># Make an HTML play for showing the animation in a browser</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">movie</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                  <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;movie.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu</span>

<span class="k">def</span> <span class="nf">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangular wave (pulled guitar string).&quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">L</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">440</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">L</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">freq</span><span class="o">*</span><span class="n">wavelength</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span>
    <span class="n">num_periods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span><span class="o">*</span><span class="n">num_periods</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="c1"># Now dt is considered fixed and a list of C </span>
    <span class="c1"># values is made by reducing increasing the dx value </span>
    <span class="c1"># in steps of 10%. </span>
    <span class="n">all_C</span> <span class="o">=</span> <span class="p">[</span><span class="n">C</span><span class="p">]</span>
    <span class="n">all_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">1.1</span><span class="o">*</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">all_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2</span><span class="o">*</span><span class="n">dx</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">x0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span> <span class="k">else</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="n">umin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>  <span class="n">umax</span> <span class="o">=</span> <span class="o">-</span><span class="n">umin</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">all_C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
                 <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;scitools&#39;</span><span class="p">)</span>
    <span class="c1">#cpu = viz(I, 0, 0, c, L, dt, all_C, T, umin, umax,</span>
    <span class="c1">#             animate=True, tool=&#39;matplotlib&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cpu = &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Courant number: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">C</span><span class="p">)</span>
    <span class="c1"># The list of C values will be generated from this C value</span>
    <span class="n">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</pre></div>
</div>
<!-- --- end solution of exercise --- -->
<p>Filename: <code class="docutils literal notranslate"><span class="pre">wave_numerics_comparison</span></code>.</p>
<!-- --- end exercise --- -->
<!-- --- begin exercise --- -->
</section>
<section id="exercise-5-implementing-the-solver-function-as-a-generator">
<h2>Exercise 5: Implementing the solver function as a generator<a class="headerlink" href="#exercise-5-implementing-the-solver-function-as-a-generator" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:useraction:generator"></div>
<p>The callback function <code class="docutils literal notranslate"><span class="pre">user_action(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></code> is called from the
<code class="docutils literal notranslate"><span class="pre">solver</span></code> function (in, e.g., <code class="docutils literal notranslate"><span class="pre">wave1D_u0.py</span></code>) at every time level and lets
the user work perform desired actions with the solution, like plotting it
on the screen. We have implemented the callback function in the typical
way it would have been done in C and Fortran. Specifically, the code looks
like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">break</span>
</pre></div>
</div>
<p>Many Python programmers, however, may claim that <code class="docutils literal notranslate"><span class="pre">solver</span></code> is an iterative
process, and that iterative processes with callbacks to the user code is
more elegantly implemented as <em>generators</em>. The rest of the text has little
meaning unless you are familiar with Python generators and the <code class="docutils literal notranslate"><span class="pre">yield</span></code>
statement.</p>
<p>Instead of calling <code class="docutils literal notranslate"><span class="pre">user_action</span></code>, the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function
issues a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement, which is a kind of <code class="docutils literal notranslate"><span class="pre">return</span></code> statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">yield</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span>
</pre></div>
</div>
<p>The program control is directed back to the calling code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># Do something with u at t[n]</span>
</pre></div>
</div>
<p>When the block is done, <code class="docutils literal notranslate"><span class="pre">solver</span></code> continues with the statement after <code class="docutils literal notranslate"><span class="pre">yield</span></code>.
Note that the functionality of terminating the solution process if
<code class="docutils literal notranslate"><span class="pre">user_action</span></code> returns a <code class="docutils literal notranslate"><span class="pre">True</span></code> value is not possible to implement in the
generator case.</p>
<p>Implement the <code class="docutils literal notranslate"><span class="pre">solver</span></code> function as a generator, and plot the solution
at each time step.
Filename: <code class="docutils literal notranslate"><span class="pre">wave1D_u0_generator</span></code>.</p>
<!-- --- end exercise --- -->
<!-- --- begin exercise --- -->
</section>
<section id="project-6-calculus-with-1d-mesh-functions">
<h2>Project 6: Calculus with 1D mesh functions<a class="headerlink" href="#project-6-calculus-with-1d-mesh-functions" title="Permalink to this heading">#</a></h2>
<div id="wave:exer:mesh1D:calculus"></div>
<p>This project explores integration and differentiation of
mesh functions, both with scalar and vectorized implementations.
We are given a mesh function <span class="math notranslate nohighlight">\(f_i\)</span> on a spatial one-dimensional
mesh <span class="math notranslate nohighlight">\(x_i=i\Delta x\)</span>, <span class="math notranslate nohighlight">\(i=0,\ldots,N_x\)</span>, over the interval <span class="math notranslate nohighlight">\([a,b]\)</span>.</p>
<p><strong>a)</strong>
Define the discrete derivative of <span class="math notranslate nohighlight">\(f_i\)</span> by using centered
differences at internal mesh points and one-sided differences
at the end points. Implement a scalar version of
the computation in a Python function and write an associated unit test
for the linear case <span class="math notranslate nohighlight">\(f(x)=4x-2.5\)</span> where the discrete derivative should
be exact.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
See code below.</p>
<!-- --- end solution of exercise --- -->
<p><strong>b)</strong>
Vectorize the implementation of the discrete derivative.
Extend the unit test to check the validity of the implementation.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
See code below.</p>
<!-- --- end solution of exercise --- -->
<p><strong>c)</strong>
To compute the discrete integral <span class="math notranslate nohighlight">\(F_i\)</span> of <span class="math notranslate nohighlight">\(f_i\)</span>, we assume that
the mesh function <span class="math notranslate nohighlight">\(f_i\)</span> varies linearly between the mesh points.
Let <span class="math notranslate nohighlight">\(f(x)\)</span> be such a linear interpolant of <span class="math notranslate nohighlight">\(f_i\)</span>. We then
have</p>
<div class="math notranslate nohighlight">
\[
F_i = \int_{x_0}^{x_i} f(x) dx
\]</div>
<p>The exact integral of a piecewise linear function <span class="math notranslate nohighlight">\(f(x)\)</span> is
given by the Trapezoidal rule. Show
that if <span class="math notranslate nohighlight">\(F_{i}\)</span> is already computed, we can find <span class="math notranslate nohighlight">\(F_{i+1}\)</span>
from</p>
<div class="math notranslate nohighlight">
\[
F_{i+1} = F_i + \frac{1}{2}(f_i + f_{i+1})\Delta x
\]</div>
<p>Make a function for the scalar implementation of the discrete integral
as a mesh function. That is, the function should return
<span class="math notranslate nohighlight">\(F_i\)</span> for <span class="math notranslate nohighlight">\(i=0,\ldots,N_x\)</span>.
For a unit test one can use the fact that the above defined
discrete integral of a linear
function (say <span class="math notranslate nohighlight">\(f(x)=4x-2.5\)</span>) is exact.</p>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
We know that the difference <span class="math notranslate nohighlight">\(F_{i+1} - F_i\)</span> must amount to the area
of a trapezoid, which is exactly what <span class="math notranslate nohighlight">\(\frac{1}{2}(f_i + f_{i+1})\Delta x\)</span> is.
To show the relation above, we may start with the Trapezoidal rule:</p>
<div class="math notranslate nohighlight">
\[
F_{i+1} = \Delta x \left[\frac{1}{2}f(x_0) + \sum_{j=1}^{n-1}f(x_j) + \frac{1}{2}f(x_n) \right] \thinspace . \nonumber
\]</div>
<p>Since <span class="math notranslate nohighlight">\(n = i+1\)</span>, and since the final term in the sum may be separated out from the sum and split in two, this may be written as</p>
<div class="math notranslate nohighlight">
\[
F_{i+1} = \Delta x \left[\frac{1}{2}f(x_0) + \sum_{j=1}^{i-1}f(x_j) + \frac{1}{2}f(x_i) + \frac{1}{2}f(x_i) + \frac{1}{2}f(x_{i+1}) \right] \thinspace . \nonumber
\]</div>
<p>This may further be written as</p>
<div class="math notranslate nohighlight">
\[
F_{i+1} = \Delta x \left[\frac{1}{2}f(x_0) + \sum_{j=1}^{i-1}f(x_j) + \frac{1}{2}f(x_i)\right] + \Delta x \left[\frac{1}{2}f(x_i) + \frac{1}{2}f(x_{i+1}) \right] \thinspace . \nonumber
\]</div>
<p>Finally, this gives</p>
<div class="math notranslate nohighlight">
\[
F_{i+1} = F_i + \frac{1}{2}(f_i + f_{i+1})\Delta x
\]</div>
<p>See code below for implementation.</p>
<!-- --- end solution of exercise --- -->
<p><strong>d)</strong>
Vectorize the implementation of the discrete integral.
Extend the unit test to check the validity of the implementation.</p>
<!-- --- begin hint in exercise --- -->
<p><strong>Hint.</strong>
Interpret the recursive formula for <span class="math notranslate nohighlight">\(F_{i+1}\)</span> as a sum.
Make an array with each element of the sum and use the “cumsum”
(<code class="docutils literal notranslate"><span class="pre">numpy.cumsum</span></code>) operation to compute the accumulative sum:
<code class="docutils literal notranslate"><span class="pre">numpy.cumsum([1,3,5])</span></code> is <code class="docutils literal notranslate"><span class="pre">[1,4,9]</span></code>.</p>
<!-- --- end hint in exercise --- -->
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
See code below.</p>
<!-- --- end solution of exercise --- -->
<p><strong>e)</strong>
Create a class <code class="docutils literal notranslate"><span class="pre">MeshCalculus</span></code> that can integrate and differentiate
mesh functions. The class can just define some methods that call
the previously implemented Python functions. Here is an example
on the usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>        <span class="c1"># mesh</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                    <span class="c1"># mesh function</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>    <span class="c1"># discrete derivative</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>         <span class="c1"># discrete anti-derivative</span>
</pre></div>
</div>
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
See code below.</p>
<!-- --- end solution of exercise --- -->
<!-- --- begin solution of exercise --- -->
<p><strong>Solution.</strong>
The final version of the code reads</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Calculus with a 1D mesh function.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">MeshCalculus</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span> <span class="o">=</span> <span class="n">vectorized</span>

    <span class="k">def</span> <span class="nf">differentiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the derivative of f by centered differences, but </span>
<span class="sd">        forw and back difference at the start and end, respectively.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>     <span class="c1"># number of spatial steps</span>
        <span class="n">num_dfdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compute approximate derivatives at end-points first</span>
        <span class="n">num_dfdx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="n">dx</span>          <span class="c1"># FD approx.</span>
        <span class="n">num_dfdx</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">Nx</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="n">dx</span>     <span class="c1"># BD approx.</span>
        <span class="c1"># proceed with approximate derivatives for inner mesh points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span><span class="p">:</span>
            <span class="n">num_dfdx</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># scalar version</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
                <span class="n">num_dfdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_dfdx</span>
    
    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the integral of f(x) over the interval </span>
<span class="sd">        covered by x. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>   
        <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># starting value for iterative scheme</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span><span class="p">:</span>
            <span class="n">all_trapezoids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    
            <span class="n">all_trapezoids</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">*</span><span class="n">dx</span>   
            <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">all_trapezoids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># scalar version</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">dx</span>    
        <span class="k">return</span> <span class="n">F</span>
    
<span class="k">def</span> <span class="nf">test_differentiate</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.5</span>
    <span class="k">def</span> <span class="nf">dfdx</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">derivatives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">derivatives</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">derivatives</span>
        
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">Nx</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>    
    <span class="n">exact_dfdx</span> <span class="o">=</span> <span class="n">dfdx</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>        <span class="c1"># compute exact derivatives</span>
    <span class="c1"># test vectorized version</span>
    <span class="n">calc_v</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">num_dfdx</span>  <span class="o">=</span> <span class="n">calc_v</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="c1"># test scalar version</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">num_dfdx</span>  <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    
<span class="k">def</span> <span class="nf">test_integrate</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.5</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">Nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1">#    a = 2.5/4; b = 10; Nx = 2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>    
    <span class="c1"># The exact integral amounts to the total area of two triangles</span>
    <span class="n">I_exact</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mf">2.5</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># test vectorized version    </span>
    <span class="n">calc_v</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    <span class="n">F</span> <span class="o">=</span> <span class="n">calc_v</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">F</span><span class="p">,</span> <span class="n">I_exact</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I_exact</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">diff</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>    
    <span class="c1"># test scalar version</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>        
    <span class="n">F</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">F</span><span class="p">,</span> <span class="n">I_exact</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I_exact</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">diff</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    
    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test_differentiate</span><span class="p">()</span>
    <span class="n">test_integrate</span><span class="p">()</span>
</pre></div>
</div>
<!-- --- end solution of exercise --- -->
<p>Filename: <code class="docutils literal notranslate"><span class="pre">mesh_calculus_1D</span></code>.</p>
<!-- --- end exercise --- --></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/02_wave"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="wave1D_fd1.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Simulation of waves on a string</p>
      </div>
    </a>
    <a class="right-next"
       href="wave_placeholder.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Coming soon</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#callback-function-for-user-specific-actions">Callback function for user-specific actions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-solver-function">The solver function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verification-exact-quadratic-solution">Verification: exact quadratic solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verification-convergence-rates">Verification: convergence rates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-animating-the-solution">Visualization: animating the solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-for-administering-the-simulation">Function for administering the simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dissection-of-the-code">Dissection of the code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-movie-files">Making movie files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#skipping-frames-for-animation-speed">Skipping frames for animation speed</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-case">Running a case</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-a-scaled-pde-model">Working with a scaled PDE model</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-simulate-a-standing-wave">Exercise 1: Simulate a standing wave</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">Remarks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-add-storage-of-solution-in-a-user-action-function">Exercise 2: Add storage of solution in a user action function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-use-a-class-for-the-user-action-function">Exercise 3: Use a class for the user action function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-compare-several-courant-numbers-in-one-movie">Exercise 4: Compare several Courant numbers in one movie</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-implementing-the-solver-function-as-a-generator">Exercise 5: Implementing the solver function as a generator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-6-calculus-with-1d-mesh-functions">Project 6: Calculus with 1D mesh functions</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Devito Project Community
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>