
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Implementation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="top" title="Finite difference methods for wave equations" href="index.html" />
    <link rel="next" title="Generalization: reflecting boundaries" href="._main_wave003.html" />
    <link rel="prev" title="Simulation of waves on a string" href="._main_wave001.html" /> 
  
       <style type="text/css">
         div.admonition {
           background-color: whiteSmoke;
           border: 1px solid #bababa;
         }
       </style>
      </head>
    
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._main_wave003.html" title="Generalization: reflecting boundaries"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._main_wave001.html" title="Simulation of waves on a string"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Finite difference methods for wave equations</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="implementation-1">
<span id="wave-pde1-impl"></span><h1>Implementation<a class="headerlink" href="#implementation-1" title="Permalink to this headline">¶</a></h1>
<p id="index-0">This section presents the complete computational algorithm, its
implementation in Python code, animation of the solution, and
verification of the implementation.</p>
<p>A real implementation of the basic computational algorithm from
the sections <a class="reference internal" href="._main_wave001.html#wave-string-alg"><em>Formulating a recursive algorithm</em></a> and <a class="reference internal" href="._main_wave001.html#wave-string-impl"><em>Sketch of an implementation</em></a> can be
encapsulated in a function, taking all the input data for the problem
as arguments.  The physical input data consists of <span class="math">\(c\)</span>, <span class="math">\(I(x)\)</span>,
<span class="math">\(V(x)\)</span>, <span class="math">\(f(x,t)\)</span>, <span class="math">\(L\)</span>, and <span class="math">\(T\)</span>.  The numerical input is the mesh
parameters <span class="math">\(\Delta t\)</span> and <span class="math">\(\Delta x\)</span>.</p>
<p>Instead of specifying <span class="math">\(\Delta t\)</span> <em>and</em> <span class="math">\(\Delta x\)</span>, we can specify one
of them and the Courant number <span class="math">\(C\)</span> instead, since having explicit
control of the Courant number is convenient when investigating the
numerical method. Many find it natural to prescribe the resolution of
the spatial grid and set <span class="math">\(N_x\)</span>. The solver function can then compute
<span class="math">\(\Delta t = CL/(cN_x)\)</span>. However, for comparing <span class="math">\(u(x,t)\)</span> curves (as
functions of <span class="math">\(x\)</span>) for various Courant numbers
it is more convenient to keep <span class="math">\(\Delta t\)</span> fixed for
all <span class="math">\(C\)</span> and let <span class="math">\(\Delta x\)</span> vary according to <span class="math">\(\Delta x = c\Delta t/C\)</span>.
With <span class="math">\(\Delta t\)</span> fixed, all frames correspond to the same time <span class="math">\(t\)</span>,
and this simplifies animations that compare simulations with different
mesh resolutions. Plotting functions of <span class="math">\(x\)</span>
with different spatial resolution is trivial,
so it is easier to let <span class="math">\(\Delta x\)</span> vary in the simulations than <span class="math">\(\Delta t\)</span>.</p>
<div class="section" id="callback-function-for-user-specific-actions">
<span id="wave-pde1-impl-useraction"></span><h2>Callback function for user-specific actions<a class="headerlink" href="#callback-function-for-user-specific-actions" title="Permalink to this headline">¶</a></h2>
<p id="index-1">The solution at all spatial points at a new time level is stored in an
array <tt class="docutils literal"><span class="pre">u</span></tt> of length <span class="math">\(N_x+1\)</span>. We need to decide what to do with
this solution, e.g., visualize the curve, analyze the values, or write
the array to file for later use. The decision about what to do is left to
the user in the form of a user-supplied function</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">u</span></tt> is the solution at the spatial points <tt class="docutils literal"><span class="pre">x</span></tt> at time <tt class="docutils literal"><span class="pre">t[n]</span></tt>.
The <tt class="docutils literal"><span class="pre">user_action</span></tt> function is called from the solver at each time level <tt class="docutils literal"><span class="pre">n</span></tt>.</p>
<p>If the user wants to plot the solution or store the solution at a
time point, she needs to write such a function and take appropriate
actions inside it. We will show examples on many such <tt class="docutils literal"><span class="pre">user_action</span></tt>
functions.</p>
<p>Since the solver function makes calls back to the user&#8217;s code
via such a function, this type of function is called a <em>callback function</em>.
When writing general software, like our solver function, which also needs
to carry out special problem- or solution-dependent actions
(like visualization),
it is a common technique to leave those actions to user-supplied
callback functions.</p>
<p>The callback function can be used to terminate the solution process
if the user returns <tt class="docutils literal"><span class="pre">True</span></tt>. For example,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_user_action_function</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span>
</pre></div>
</div>
<p>is a callback function that will terminate the solver function (given below) of the
amplitude of the waves exceed 10, which is here considered as a numerical
instability.</p>
</div>
<div class="section" id="the-solver-function">
<span id="wave-pde1-impl-solver"></span><h2>The solver function<a class="headerlink" href="#the-solver-function" title="Permalink to this headline">¶</a></h2>
<p id="index-2">A first attempt at a solver function is listed below.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve u_tt=c^2*u_xx + f on (0,L)x(0,T].&quot;&quot;&quot;</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Mesh points in time</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Mesh points in space</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>                         <span class="c1"># Help variable in the scheme</span>
    <span class="c1"># Make sure dx and dt are compatible with x and t</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>

    <span class="n">u</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution array at new time level</span>
    <span class="n">u_n</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 1 time level back</span>
    <span class="n">u_nm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Solution at 2 time levels back</span>

    <span class="kn">import</span> <span class="nn">time</span><span class="p">;</span>  <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>  <span class="c1"># Measure CPU time</span>

    <span class="c1"># Load initial condition into u_n</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u_n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Special formula for first time step</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Switch variables before next step</span>
    <span class="n">u_nm1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_n</span><span class="p">;</span>  <span class="n">u_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>
        <span class="c1"># Update all inner points at time t[n+1]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">u_nm1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="c1"># Insert boundary conditions</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">u</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="c1"># Switch variables before next step</span>
        <span class="n">u_nm1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_n</span><span class="p">;</span>  <span class="n">u_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="n">cpu_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu_time</span>
</pre></div>
</div>
<p>A couple of remarks about the above code is perhaps necessary:</p>
<blockquote>
<div><ul class="simple">
<li>Although we give <tt class="docutils literal"><span class="pre">dt</span></tt> and compute <tt class="docutils literal"><span class="pre">dx</span></tt> via <tt class="docutils literal"><span class="pre">C</span></tt> and <tt class="docutils literal"><span class="pre">c</span></tt>, the resulting
<tt class="docutils literal"><span class="pre">t</span></tt> and <tt class="docutils literal"><span class="pre">x</span></tt> meshes do not necessarily correspond exactly to these values
because of rounding errors. To explicitly ensure that <tt class="docutils literal"><span class="pre">dx</span></tt> and <tt class="docutils literal"><span class="pre">dt</span></tt>
correspond to the cell sizes in <tt class="docutils literal"><span class="pre">x</span></tt> and <tt class="docutils literal"><span class="pre">t</span></tt>, we recompute the values.</li>
<li>According to the particular choice made in the section <a class="reference internal" href="#wave-pde1-impl-useraction"><em>Callback function for user-specific actions</em></a>, a true value returned from <tt class="docutils literal"><span class="pre">user_action</span></tt> should terminate the simulation. This is here implemented by a <tt class="docutils literal"><span class="pre">break</span></tt> statement inside the for loop in the solver.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="verification-exact-quadratic-solution">
<span id="wave-pde1-impl-verify-quadratic"></span><h2>Verification: exact quadratic solution<a class="headerlink" href="#verification-exact-quadratic-solution" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-3"></span><span class="target" id="index-4"></span><span class="target" id="index-5"></span><span class="target" id="index-6"></span><span class="target" id="index-7"></span><p id="index-8">We use the test problem derived in the section <a class="reference internal" href="._main_wave001.html#wave-pde2-fd"><em>A slightly generalized model problem</em></a> for
verification. Below is a unit test based on this test problem
and realized as a proper <em>test function</em> compatible with the unit test
frameworks nose or pytest.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_quadratic</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check that u(x,t)=x(L-x)(1+t/2) is exactly reproduced.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Very coarse mesh for this exact test</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">def</span> <span class="nf">assert_no_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-13</span>
        <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">)</span>
</pre></div>
</div>
<p>When this function resides in the file <tt class="docutils literal"><span class="pre">wave1D_u0.py</span></tt>, one can run
pytest to check that all test functions with names <tt class="docutils literal"><span class="pre">test_*()</span></tt>
in this file work:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Terminal&gt; py.test -s -v wave1D_u0.py
</pre></div>
</div>
</div>
<div class="section" id="verification-convergence-rates">
<span id="wave-pde1-impl-verify-rate"></span><h2>Verification: convergence rates<a class="headerlink" href="#verification-convergence-rates" title="Permalink to this headline">¶</a></h2>
<p id="index-9">A more general method, but not so reliable as a verification method,
is to compute the convergence rates and see if they coincide with
theoretical estimates. Here we expect a rate of 2 according to
the various results in the section <a class="reference internal" href="._main_wave004.html#wave-pde1-analysis"><em>Analysis of the difference equations</em></a>.
A general function for computing convergence rates can be written like
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convergence_rates</span><span class="p">(</span>
    <span class="n">u_exact</span><span class="p">,</span>                 <span class="c1"># Python function for exact solution</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span>           <span class="c1"># physical parameters</span>
    <span class="n">dt0</span><span class="p">,</span> <span class="n">num_meshes</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>  <span class="c1"># numerical parameters</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Half the time step and estimate convergence rates for</span>
<span class="sd">    for num_meshes simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First define an appropriate user action function</span>
    <span class="k">global</span> <span class="n">error</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># error computed in the user action function</span>

    <span class="k">def</span> <span class="nf">compute_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">error</span>  <span class="c1"># must be global to be altered here</span>
        <span class="c1"># (otherwise error is a local variable, different</span>
        <span class="c1"># from error defined in the parent function)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Run finer and finer resolutions and compute true errors</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># dt, solver adjusts dx such that C=dt*c/dx</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_meshes</span><span class="p">):</span>
        <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
               <span class="n">user_action</span><span class="o">=</span><span class="n">compute_error</span><span class="p">)</span>
        <span class="c1"># error is computed in the final call to compute_error</span>
        <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">/=</span> <span class="mi">2</span>  <span class="c1"># halve the time step for next simulation</span>
    <span class="k">print</span> <span class="s1">&#39;E:&#39;</span><span class="p">,</span> <span class="n">E</span>
    <span class="k">print</span> <span class="s1">&#39;h:&#39;</span><span class="p">,</span> <span class="n">h</span>
    <span class="c1"># Convergence rates for two consecutive experiments</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_meshes</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>
</div>
<p>Using the analytical solution from the section <a class="reference internal" href="._main_wave001.html#wave-pde2-fd-standing-waves"><em>Using an analytical solution of physical significance</em></a>, we can call <tt class="docutils literal"><span class="pre">convergence_rates</span></tt> to
see if we get a convergence rate that approaches 2 and use the final
estimate of the rate in an <tt class="docutils literal"><span class="pre">assert</span></tt> statement such that this function becomes
a proper test function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_convrate_sincos</span><span class="p">():</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">u_exact</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">L</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">L</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">convergence_rates</span><span class="p">(</span>
        <span class="n">u_exact</span><span class="o">=</span><span class="n">u_exact</span><span class="p">,</span>
        <span class="n">I</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">V</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
        <span class="n">dt0</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">num_meshes</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">C</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;rates sin(x)*cos(t) solution:&#39;</span><span class="p">,</span> \
          <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.002</span>
</pre></div>
</div>
<p>Doing <tt class="docutils literal"><span class="pre">py.test</span> <span class="pre">-s</span> <span class="pre">-v</span> <span class="pre">wave1D_u0.py</span></tt> will run also this test function and
show the rates 2.05, 1.98, 2.00, 2.00, and 2.00 (to two decimals).</p>
</div>
<div class="section" id="visualization-animating-the-solution">
<span id="wave-pde1-impl-animate"></span><h2>Visualization: animating the solution<a class="headerlink" href="#visualization-animating-the-solution" title="Permalink to this headline">¶</a></h2>
<p>Now that we have verified the implementation it is time to do a
real computation where we also display evolution of the waves
on the screen. Since the <tt class="docutils literal"><span class="pre">solver</span></tt> function knows nothing about
what type of visualizations we may want, it calls the callback function
<tt class="docutils literal"><span class="pre">user_action(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></tt>. We must therefore write this function and
find the proper statements for plotting the solution.</p>
<div class="section" id="function-for-administering-the-simulation">
<h3>Function for administering the simulation<a class="headerlink" href="#function-for-administering-the-simulation" title="Permalink to this headline">¶</a></h3>
<p>The following <tt class="docutils literal"><span class="pre">viz</span></tt> function</p>
<ol class="arabic simple">
<li>defines a <tt class="docutils literal"><span class="pre">user_action</span></tt> callback function
for plotting the solution at each time level,</li>
<li>calls the <tt class="docutils literal"><span class="pre">solver</span></tt> function, and</li>
<li>combines all the plots (in files) to video in different formats.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run solver and visualize u at each time level.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">plot_u_st</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span>
                 <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Let the initial condition stay on the screen for 2</span>
        <span class="c1"># seconds, else insert a pause of 0.2 s between each plot</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;frame_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">class</span> <span class="nc">PlotMatplotlib</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;user_action function for solver.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;t=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># for movie making</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">PlotMatplotlib</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scitools.std</span> <span class="kn">as</span> <span class="nn">plt</span>  <span class="c1"># scitools.easyviz interface</span>
        <span class="n">plot_u</span> <span class="o">=</span> <span class="n">plot_u_st</span>
    <span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span>

    <span class="c1"># Clean up old movie frames</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Call solver and do the simulaton</span>
    <span class="n">user_action</span> <span class="o">=</span> <span class="n">plot_u</span> <span class="k">if</span> <span class="n">animate</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">solver_function</span><span class="p">(</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">user_action</span><span class="p">)</span>

    <span class="c1"># Make video files</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frames per second</span>
    <span class="n">codec2ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flv</span><span class="o">=</span><span class="s1">&#39;flv&#39;</span><span class="p">,</span> <span class="n">libx264</span><span class="o">=</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">libvpx</span><span class="o">=</span><span class="s1">&#39;webm&#39;</span><span class="p">,</span>
                     <span class="n">libtheora</span><span class="o">=</span><span class="s1">&#39;ogg&#39;</span><span class="p">)</span>  <span class="c1"># video formats</span>
    <span class="n">filespec</span> <span class="o">=</span> <span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span>
    <span class="n">movie_program</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span>  <span class="c1"># or &#39;ffmpeg&#39;</span>
    <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codec2ext</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">codec2ext</span><span class="p">[</span><span class="n">codec</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(movie_program)s</span><span class="s1"> -r </span><span class="si">%(fps)d</span><span class="s1"> -i </span><span class="si">%(filespec)s</span><span class="s1"> &#39;</span>\
              <span class="s1">&#39;-vcodec </span><span class="si">%(codec)s</span><span class="s1"> movie.</span><span class="si">%(ext)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tool</span> <span class="o">==</span> <span class="s1">&#39;scitools&#39;</span><span class="p">:</span>
        <span class="c1"># Make an HTML play for showing the animation in a browser</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">movie</span><span class="p">(</span><span class="s1">&#39;tmp_*.png&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                  <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;movie.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu</span>
</pre></div>
</div>
</div>
<div class="section" id="dissection-of-the-code">
<h3>Dissection of the code<a class="headerlink" href="#dissection-of-the-code" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-10"></span><span class="target" id="index-11"></span><span class="target" id="index-12"></span><span class="target" id="index-13"></span><p id="index-14">The <tt class="docutils literal"><span class="pre">viz</span></tt> function can either use SciTools or Matplotlib for
visualizing the solution. The <tt class="docutils literal"><span class="pre">user_action</span></tt> function based on SciTools
is called <tt class="docutils literal"><span class="pre">plot_u_st</span></tt>, while the <tt class="docutils literal"><span class="pre">user_action</span></tt> function based on
Matplotlib is a bit more complicated as it is realized as a class and
needs statements that differ from those for making static plots.
SciTools can utilize both Matplotlib and Gnuplot (and many other
plotting programs) for doing the graphics, but Gnuplot is a relevant
choice for large <span class="math">\(N_x\)</span> or in two-dimensional problems
as Gnuplot is significantly faster than
Matplotlib for screen animations.</p>
<p id="index-15">A function inside another function, like <tt class="docutils literal"><span class="pre">plot_u_st</span></tt> in the above code
segment, has access to <em>and remembers</em> all the local variables in the
surrounding code inside the <tt class="docutils literal"><span class="pre">viz</span></tt> function (!). This is known in
computer science as a <em>closure</em> and is very convenient to program
with. For example, the <tt class="docutils literal"><span class="pre">plt</span></tt> and <tt class="docutils literal"><span class="pre">time</span></tt> modules defined outside
<tt class="docutils literal"><span class="pre">plot_u</span></tt> are accessible for <tt class="docutils literal"><span class="pre">plot_u_st</span></tt> when the function is called
(as <tt class="docutils literal"><span class="pre">user_action</span></tt>) in the <tt class="docutils literal"><span class="pre">solver</span></tt> function.  Some may think, however,
that a class instead of a closure is a cleaner and
easier-to-understand implementation of the user action function, see
the section <a class="reference internal" href="._main_wave003.html#wave-pde2-software"><em>Building a general 1D wave equation solver</em></a>.</p>
<p>The <tt class="docutils literal"><span class="pre">plot_u_st</span></tt> function just makes a standard SciTools <tt class="docutils literal"><span class="pre">plot</span></tt> command
for plotting <tt class="docutils literal"><span class="pre">u</span></tt> as a function of <tt class="docutils literal"><span class="pre">x</span></tt> at time <tt class="docutils literal"><span class="pre">t[n]</span></tt>.  To achieve a
smooth animation, the <tt class="docutils literal"><span class="pre">plot</span></tt> command should take keyword arguments
instead of being broken into separate calls to <tt class="docutils literal"><span class="pre">xlabel</span></tt>, <tt class="docutils literal"><span class="pre">ylabel</span></tt>,
<tt class="docutils literal"><span class="pre">axis</span></tt>, <tt class="docutils literal"><span class="pre">time</span></tt>, and <tt class="docutils literal"><span class="pre">show</span></tt>.  Several <tt class="docutils literal"><span class="pre">plot</span></tt> calls will automatically
cause an animation on the screen. In addition, we want to save each
frame in the animation to file. We then need a filename where the
frame number is padded with zeros, here <tt class="docutils literal"><span class="pre">tmp_0000.png</span></tt>,
<tt class="docutils literal"><span class="pre">tmp_0001.png</span></tt>, and so on.  The proper printf construction is then
<tt class="docutils literal"><span class="pre">tmp_%04d.png</span></tt>.</p>
<p>The solver is called with an argument <tt class="docutils literal"><span class="pre">plot_u</span></tt> as <tt class="docutils literal"><span class="pre">user_function</span></tt>.
If the user chooses to use SciTools, <tt class="docutils literal"><span class="pre">plot_u</span></tt> is the <tt class="docutils literal"><span class="pre">plot_u_st</span></tt>
callback function, but for Matplotlib it is an instance of the
class <tt class="docutils literal"><span class="pre">PlotMatplotlib</span></tt>. Also this class makes use of variables
defined in the <tt class="docutils literal"><span class="pre">viz</span></tt> function: <tt class="docutils literal"><span class="pre">plt</span></tt> and <tt class="docutils literal"><span class="pre">time</span></tt>.
With Matplotlib, one has to make the first plot the standard way, and
then update the <span class="math">\(y\)</span> data in the plot at every time level. The update
requires active use of the returned value from <tt class="docutils literal"><span class="pre">plt.plot</span></tt> in the first
plot.  This value would need to be stored in a local variable if we
were to use a closure for the <tt class="docutils literal"><span class="pre">user_action</span></tt> function when doing the
animation with Matplotlib. It is much easier to store the
variable as a class attribute <tt class="docutils literal"><span class="pre">self.lines</span></tt>. Since the class is essentially a
function, we implement the function as the special method <tt class="docutils literal"><span class="pre">__call__</span></tt>
such that the instance <tt class="docutils literal"><span class="pre">plot_u(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></tt> can be called as a standard
callback function from <tt class="docutils literal"><span class="pre">solver</span></tt>.</p>
</div>
<div class="section" id="making-movie-files">
<h3>Making movie files<a class="headerlink" href="#making-movie-files" title="Permalink to this headline">¶</a></h3>
<p>From the
<tt class="docutils literal"><span class="pre">frame_*.png</span></tt> files containing the frames in the animation we can
make video files.
We use the <tt class="docutils literal"><span class="pre">ffmpeg</span></tt> (or <tt class="docutils literal"><span class="pre">ffmpeg</span></tt>) program to combine individual
plot files to movies in modern formats: Flash, MP4, Webm, and Ogg.
A typical <tt class="docutils literal"><span class="pre">ffmpeg</span></tt> (or <tt class="docutils literal"><span class="pre">ffmpeg</span></tt>) command for creating a movie file
in Ogg format
with 4 frames per second built from a collection of
plot files with names generated by <tt class="docutils literal"><span class="pre">frame_%04d.png</span></tt>,
look like</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libtheora movie.ogg
</pre></div>
</div>
<p>The different formats require different video encoders (<tt class="docutils literal"><span class="pre">-c:v</span></tt>) to
be installed: Flash applies <tt class="docutils literal"><span class="pre">flv</span></tt>, WebM applies <tt class="docutils literal"><span class="pre">libvpx</span></tt>, and MP4
applies <tt class="docutils literal"><span class="pre">libx264</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v flv movie.flv
Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libvpx movie.webm
Terminal&gt; ffmpeg -r 25 -i frame_%04d.png -c:v libx264 movie.mp4
</pre></div>
</div>
<p>Players like <tt class="docutils literal"><span class="pre">vlc</span></tt>, <tt class="docutils literal"><span class="pre">mplayer</span></tt>, <tt class="docutils literal"><span class="pre">gxine</span></tt>, and <tt class="docutils literal"><span class="pre">totem</span></tt>
can be used to play these movie files.</p>
<p>Note that padding the frame counter with zeros in the <tt class="docutils literal"><span class="pre">frame_*.png</span></tt>
files, as specified by the <tt class="docutils literal"><span class="pre">%04d</span></tt> format, is essential so that the wildcard
notation <tt class="docutils literal"><span class="pre">frame_*.png</span></tt> expands to the correct set of files.</p>
<p>The <tt class="docutils literal"><span class="pre">viz</span></tt> function creates an <tt class="docutils literal"><span class="pre">ffmpeg</span></tt> or <tt class="docutils literal"><span class="pre">ffmpeg</span></tt> command
with the proper arguments for each of the formats Flash, MP4, WebM,
and Ogg. The task is greatly simplified by having a
<tt class="docutils literal"><span class="pre">codec2ext</span></tt> dictionary for mapping
video codec names to filename extensions.
Only
two formats are actually needed to ensure that all browsers can
successfully play the video: MP4 and WebM.</p>
<p>Some animations having a large number of plot files may not
be properly combined into a video using <tt class="docutils literal"><span class="pre">ffmpeg</span></tt> or <tt class="docutils literal"><span class="pre">ffmpeg</span></tt>.
A method that always works is to play the PNG files as an animation
in a browser using JavaScript code in an HTML file.
The SciTools package has a function <tt class="docutils literal"><span class="pre">movie</span></tt> (or a stand-alone command
<tt class="docutils literal"><span class="pre">scitools</span> <span class="pre">movie</span></tt>) for creating such an HTML player. The <tt class="docutils literal"><span class="pre">plt.movie</span></tt>
call in the <tt class="docutils literal"><span class="pre">viz</span></tt> function shows how the function is used.
The file <tt class="docutils literal"><span class="pre">movie.html</span></tt> can be loaded into a browser and features
a user interface where the speed of the animation can be controlled.
Note that the movie in this case consists of the <tt class="docutils literal"><span class="pre">movie.html</span></tt> file
and all the frame files <tt class="docutils literal"><span class="pre">tmp_*.png</span></tt>.</p>
</div>
<div class="section" id="skipping-frames-for-animation-speed">
<h3>Skipping frames for animation speed<a class="headerlink" href="#skipping-frames-for-animation-speed" title="Permalink to this headline">¶</a></h3>
<p>Sometimes the time step is small and <span class="math">\(T\)</span> is large, leading to an
inconveniently large number of plot files and a slow animation on the
screen. The solution to such a problem is to decide on a total number
of frames in the animation, <tt class="docutils literal"><span class="pre">num_frames</span></tt>, and plot the solution only for
every <tt class="docutils literal"><span class="pre">skip_frame</span></tt> frames. For example, setting <tt class="docutils literal"><span class="pre">skip_frame=5</span></tt> leads
to plots of every 5 frames. The default value <tt class="docutils literal"><span class="pre">skip_frame=1</span></tt> plots
every frame.
The total number of time levels (i.e., maximum
possible number of frames) is the length of <tt class="docutils literal"><span class="pre">t</span></tt>, <tt class="docutils literal"><span class="pre">t.size</span></tt> (or <tt class="docutils literal"><span class="pre">len(t)</span></tt>),
so if we want <tt class="docutils literal"><span class="pre">num_frames</span></tt> frames in the animation,
we need to plot every <tt class="docutils literal"><span class="pre">t.size/num_frames</span></tt> frames:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">skip_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_frames</span><span class="p">))</span>
<span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">skip_frame</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The initial condition (<tt class="docutils literal"><span class="pre">n=0</span></tt>) is included by <tt class="docutils literal"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span> <span class="pre">==</span> <span class="pre">0</span></tt>,
as well as every <tt class="docutils literal"><span class="pre">skip_frame</span></tt>-th frame.
As <tt class="docutils literal"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span> <span class="pre">==</span> <span class="pre">0</span></tt> will very seldom be true for the
very final frame, we must also check if <tt class="docutils literal"><span class="pre">n</span> <span class="pre">==</span> <span class="pre">t.size-1</span></tt> to
get the final frame included.</p>
<p>A simple choice of numbers may illustrate the formulas: say we have
801 frames in total (<tt class="docutils literal"><span class="pre">t.size</span></tt>) and we allow only 60 frames to be
plotted. As <tt class="docutils literal"><span class="pre">n</span></tt> then runs from 801 to 0, we need to plot every 801/60
frame, which with integer division yields 13 as <tt class="docutils literal"><span class="pre">skip_frame</span></tt>. Using
the mod function, <tt class="docutils literal"><span class="pre">n</span> <span class="pre">%</span> <span class="pre">skip_frame</span></tt>, this operation is zero every time
<tt class="docutils literal"><span class="pre">n</span></tt> can be divided by 13 without a remainder. That is, the <tt class="docutils literal"><span class="pre">if</span></tt> test
is true when <tt class="docutils literal"><span class="pre">n</span></tt> equals <span class="math">\(0, 13, 26, 39, ..., 780, 801\)</span>. The associated
code is included in the <tt class="docutils literal"><span class="pre">plot_u</span></tt> function, inside the <tt class="docutils literal"><span class="pre">viz</span></tt> function,
in the file <a class="reference external" href="http://tinyurl.com/nu656p2/wave/wave1D/wave1D_u0.py">wave1D_u0.py</a>.</p>
</div>
</div>
<div class="section" id="running-a-case">
<span id="wave-pde1-guitar-data"></span><h2>Running a case<a class="headerlink" href="#running-a-case" title="Permalink to this headline">¶</a></h2>
<p>The first demo of our 1D wave equation solver concerns vibrations of a
string that is initially deformed to a triangular shape, like when picking
a guitar string:</p>
<div class="math" id="eq-wave-pde1-guitar-i">
\[\begin{split}\tag{33}
I(x) = \left\lbrace
    \begin{array}{ll}
    ax/x_0, &amp; x &lt; x_0,\\
    a(L-x)/(L-x_0), &amp; \hbox{otherwise}
    \end{array}\right.\end{split}\]</div>
<p>We choose <span class="math">\(L=75\)</span> cm, <span class="math">\(x_0=0.8L\)</span>, <span class="math">\(a=5\)</span> mm, and a time frequency
<span class="math">\(\nu = 440\)</span> Hz. The relation between the wave speed <span class="math">\(c\)</span> and <span class="math">\(\nu\)</span> is
<span class="math">\(c=\nu\lambda\)</span>, where <span class="math">\(\lambda\)</span> is the wavelength, taken as <span class="math">\(2L\)</span> because
the longest wave on the string forms half a wavelength. There is no
external force, so <span class="math">\(f=0\)</span> (meaning we can neglect gravity),
and the string is at rest initially, implying <span class="math">\(V=0\)</span>.</p>
<p>Regarding numerical parameters, we need to specify a <span class="math">\(\Delta t\)</span>.
Sometimes it is more natural to think of a spatial resolution instead
of a time step. A natural semi-coarse spatial resolution in the present
problem is <span class="math">\(N_x=50\)</span>. We can then choose the associated <span class="math">\(\Delta t\)</span> (as required
by the <tt class="docutils literal"><span class="pre">viz</span></tt> and <tt class="docutils literal"><span class="pre">solver</span></tt> functions) as the stability limit:
<span class="math">\(\Delta t = L/(N_xc)\)</span>. This is the <span class="math">\(\Delta t\)</span> to be specified,
but notice that if <span class="math">\(C&lt;1\)</span>, the actual <span class="math">\(\Delta x\)</span> computed in <tt class="docutils literal"><span class="pre">solver</span></tt> gets
larger than <span class="math">\(L/N_x\)</span>: <span class="math">\(\Delta x = c\Delta t/C = L/(N_xC)\)</span>. (The reason
is that we fix <span class="math">\(\Delta t\)</span> and adjust <span class="math">\(\Delta x\)</span>, so if <span class="math">\(C\)</span> gets
smaller, the code implements this effect in terms of a larger <span class="math">\(\Delta x\)</span>.)</p>
<p>A function for setting the physical and numerical parameters and
calling <tt class="docutils literal"><span class="pre">viz</span></tt> in this application goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">guitar</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Triangular wave (pulled guitar string).&quot;&quot;&quot;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">L</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">440</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">L</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">freq</span><span class="o">*</span><span class="n">wavelength</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span>
    <span class="n">num_periods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">omega</span><span class="o">*</span><span class="n">num_periods</span>
    <span class="c1"># Choose dt the same as the stability limit for Nx=50</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mf">50.</span><span class="o">/</span><span class="n">c</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">x0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span> <span class="k">else</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="n">umin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">a</span><span class="p">;</span>  <span class="n">umax</span> <span class="o">=</span> <span class="o">-</span><span class="n">umin</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
              <span class="n">animate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;scitools&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The associated program has the name <a class="reference external" href="http://tinyurl.com/nu656p2/wave/wave1D/wave1D_u0.py">wave1D_u0.py</a>. Run
the program and watch the <a class="reference external" href="http://tinyurl.com/hbcasmj/wave/html/mov-wave/guitar_C0.8/movie.html">movie of the vibrating string</a>.
The string should ideally consist of straight segments, but these are
somewhat wavy due to numerical approximation. Run the case with the
<tt class="docutils literal"><span class="pre">wave1D_u0.py</span></tt> code and <span class="math">\(C=1\)</span> to see the exact solution.</p>
</div>
<div class="section" id="working-with-a-scaled-pde-model">
<h2>Working with a scaled PDE model<a class="headerlink" href="#working-with-a-scaled-pde-model" title="Permalink to this headline">¶</a></h2>
<p id="index-16">Depending on the model, it may be a substantial job to establish
consistent and relevant physical parameter values for a case.  The
guitar string example illustrates the point.  However, by <em>scaling</em>
the mathematical problem we can often reduce the need to estimate
physical parameters dramatically. The scaling technique consists of
introducing new independent and dependent variables, with the aim that
the absolute values of these lie in <span class="math">\([0,1]\)</span>. We introduce the
dimensionless variables (details are found in Section 3.1.1 in <a class="reference internal" href="._main_wave008.html#ref2" id="id1">[Ref2]</a>)</p>
<div class="math">
\[\bar x = \frac{x}{L},\quad \bar t = \frac{c}{L}t,\quad
\bar u = \frac{u}{a}
{\thinspace .}\]</div>
<p>Here, <span class="math">\(L\)</span> is a typical length scale, e.g., the length of the domain,
and <span class="math">\(a\)</span> is a typical size of <span class="math">\(u\)</span>, e.g., determined from the
initial condition: <span class="math">\(a=\max_x|I(x)|\)</span>.</p>
<p>We get by the chain rule that</p>
<div class="math">
\[\frac{\partial u}{\partial t} =
\frac{\partial}{\partial\bar t}\left(a\bar u\right)
\frac{d\bar t}{dt} =
\frac{ac}{L}\frac{\partial\bar u}{\partial\bar t}{\thinspace .}\]</div>
<p>Similarly,</p>
<div class="math">
\[\frac{\partial u}{\partial x}
= \frac{a}{L}\frac{\partial\bar u}{\partial\bar x}{\thinspace .}\]</div>
<p>Inserting the dimensionless variables in the PDE gives, in case <span class="math">\(f=0\)</span>,</p>
<div class="math">
\[\frac{a^2c^2}{L^2}\frac{\partial^2\bar u}{\partial\bar t^2}
= \frac{a^2c^2}{L^2}\frac{\partial^2\bar u}{\partial\bar x^2}{\thinspace .}\]</div>
<p>Dropping the bars, we arrive at the scaled PDE</p>
<div class="math" id="eq-auto10">
\[\tag{34}
\frac{\partial^2 u}{\partial t^2} = \frac{\partial^2 u}{\partial x^2},
    \quad x\in (0,1),\ t\in (0,cT/L),\]</div>
<p>which has no parameter <span class="math">\(c^2\)</span> anymore. The initial conditions are scaled
as</p>
<div class="math">
\[a\bar u(\bar x, 0) = I(L\bar x)\]</div>
<p>and</p>
<div class="math">
\[\frac{a}{L/c}\frac{\partial\bar u}{\partial\bar t}(\bar x,0) = V(L\bar x),\]</div>
<p>resulting in</p>
<div class="math">
\[\bar u(\bar x, 0) = \frac{I(L\bar x)}{\max_x |I(x)|},\quad
\frac{\partial\bar u}{\partial\bar t}(\bar x,0) = \frac{L}{ac}V(L\bar x){\thinspace .}\]</div>
<p>In the common case <span class="math">\(V=0\)</span> we see that there are no physical parameters to be
estimated in the PDE model!</p>
<p>If we have a program implemented for the physical wave equation with
dimensions, we can obtain the dimensionless, scaled version by
setting <span class="math">\(c=1\)</span>. The initial condition of a guitar string,
given in <a class="reference internal" href="#eq-wave-pde1-guitar-i"><em>(33)</em></a>, gets its scaled form by choosing
<span class="math">\(a=1\)</span>, <span class="math">\(L=1\)</span>, and <span class="math">\(x_0\in [0,1]\)</span>. This means that we only need to
decide on the <span class="math">\(x_0\)</span> value as a fraction of unity, because
the scaled problem corresponds to setting all
other parameters to unity. In the code we can just set
<tt class="docutils literal"><span class="pre">a=c=L=1</span></tt>, <tt class="docutils literal"><span class="pre">x0=0.8</span></tt>, and there is no need to calculate with
wavelengths and frequencies to estimate <span class="math">\(c\)</span>!</p>
<p>The only non-trivial parameter to estimate in the scaled problem
is the final end time of the simulation, or more precisely, how it relates
to periods in periodic solutions in time, since we often want to
express the end time as a certain number of periods.
The period in the dimensionless problem is 2, so the end time can be
set to the desired number of periods times 2.</p>
<p>Why the dimensionless period is 2 can be explained by the following
reasoning.
Suppose that <span class="math">\(u\)</span> behaves as <span class="math">\(\cos (\omega t)\)</span> in time in the original
problem with dimensions. The corresponding period is then <span class="math">\(P=2\pi/\omega\)</span>, but
we need to estimate <span class="math">\(\omega\)</span>. A typical solution of the wave
equation is <span class="math">\(u(x,t)=A\cos(kx)\cos(\omega t)\)</span>, where <span class="math">\(A\)</span> is an amplitude
and <span class="math">\(k\)</span> is related to the wave length <span class="math">\(\lambda\)</span> in space: <span class="math">\(\lambda = 2\pi/k\)</span>.
Both <span class="math">\(\lambda\)</span> and <span class="math">\(A\)</span> will be given by the initial condition <span class="math">\(I(x)\)</span>.
Inserting this <span class="math">\(u(x,t)\)</span> in the PDE yields <span class="math">\(-\omega^2 = -c^2k^2\)</span>, i.e.,
<span class="math">\(\omega = kc\)</span>. The period is therefore <span class="math">\(P=2\pi/(kc)\)</span>.
If the boundary conditions are <span class="math">\(u(0,t)=u(L,t)\)</span>, we need to have
<span class="math">\(kL = n\pi\)</span> for integer <span class="math">\(n\)</span>. The period becomes <span class="math">\(P=2L/nc\)</span>. The longest
period is <span class="math">\(P=2L/c\)</span>. The dimensionless period <span class="math">\(\tilde P\)</span> is obtained
by dividing <span class="math">\(P\)</span> by the time scale <span class="math">\(L/c\)</span>, which results in <span class="math">\(\tilde P=2\)</span>.
Shorter waves in the initial condition will have a dimensionless
shorter period <span class="math">\(\tilde P=2/n\)</span> (<span class="math">\(n&gt;1\)</span>).</p>
</div>
</div>
<div class="section" id="vectorization">
<span id="wave-pde1-impl-vec"></span><h1>Vectorization<a class="headerlink" href="#vectorization" title="Permalink to this headline">¶</a></h1>
<span class="target" id="index-17"></span><span class="target" id="index-18"></span><span class="target" id="index-19"></span><span class="target" id="index-20"></span><span class="target" id="index-21"></span><p id="index-22">The computational algorithm for solving the wave equation visits one
mesh point at a time and evaluates a formula for the new value
<span class="math">\(u_i^{n+1}\)</span> at that point. Technically, this is implemented by a loop
over array elements in a program. Such loops may run slowly in Python
(and similar interpreted languages such as R and MATLAB).  One
technique for speeding up loops is to perform operations on entire
arrays instead of working with one element at a time. This is referred
to as <em>vectorization</em>, <em>vector computing</em>, or <em>array computing</em>.
Operations on whole arrays are possible if the computations involving
each element is independent of each other and therefore can, at least
in principle, be performed simultaneously.  That is, vectorization not
only speeds up the code on serial computers, but also makes it easy to
exploit parallel computing. Actually, there are Python tools like
<a class="reference external" href="http://numba.pydata.org">Numba</a> that can automatically turn
vectorized code into parallel code.</p>
<div class="section" id="operations-on-slices-of-arrays">
<span id="wave-pde1-impl-vec-slices-basics"></span><h2>Operations on slices of arrays<a class="headerlink" href="#operations-on-slices-of-arrays" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-23"></span><span class="target" id="index-24"></span><span class="target" id="index-25"></span><span class="target" id="index-26"></span><p id="index-27">Efficient computing with <tt class="docutils literal"><span class="pre">numpy</span></tt> arrays demands that we avoid loops
and compute with entire arrays at once (or at least large portions of them).
Consider this calculation of differences <span class="math">\(d_i = u_{i+1}-u_i\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<p>All the differences here are independent of each other.
The computation of <tt class="docutils literal"><span class="pre">d</span></tt> can therefore alternatively be done by
subtracting the array <span class="math">\((u_0,u_1,\ldots,u_{n-1})\)</span> from
the array where the elements are shifted one index upwards:
<span class="math">\((u_1,u_2,\ldots,u_n)\)</span>, see Figure <a class="reference internal" href="#wave-pde1-vec-fig1"><em>Illustration of subtracting two slices of two arrays</em></a>.
The former subset of the array can be
expressed by <tt class="docutils literal"><span class="pre">u[0:n-1]</span></tt>,
<tt class="docutils literal"><span class="pre">u[0:-1]</span></tt>, or just
<tt class="docutils literal"><span class="pre">u[:-1]</span></tt>, meaning from index 0 up to,
but not including, the last element (<tt class="docutils literal"><span class="pre">-1</span></tt>). The latter subset
is obtained by <tt class="docutils literal"><span class="pre">u[1:n]</span></tt> or <tt class="docutils literal"><span class="pre">u[1:]</span></tt>,
meaning from index 1 and the rest of the array.
The computation of <tt class="docutils literal"><span class="pre">d</span></tt> can now be done without an explicit Python loop:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>or with explicit limits if desired:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Indices with a colon, going from an index to (but not including) another
index are called <em>slices</em>. With <tt class="docutils literal"><span class="pre">numpy</span></tt> arrays, the computations
are still done by loops, but in efficient, compiled, highly optimized
C or Fortran code. Such loops are sometimes referred to as <em>vectorized
loops</em>. Such loops can also easily be distributed
among many processors on parallel computers. We say that the <em>scalar code</em>
above, working on an element (a scalar) at a time, has been replaced by
an equivalent <em>vectorized code</em>. The process of vectorizing code is called
<em>vectorization</em>.</p>
<div class="figure" id="wave-pde1-vec-fig1">
<a class="reference internal image-reference" href="_images/vectorized_diff.png"><img alt="_images/vectorized_diff.png" src="_images/vectorized_diff.png" style="width: 400px;" /></a>
<p class="caption"><em>Illustration of subtracting two slices of two arrays</em></p>
</div>
<div class="admonition-test-your-understanding admonition">
<p class="first admonition-title">Test your understanding</p>
<p class="last">Newcomers to vectorization are encouraged to choose
a small array <tt class="docutils literal"><span class="pre">u</span></tt>, say with five elements,
and simulate with pen and paper
both the loop version and the vectorized version above.</p>
</div>
<p>Finite difference schemes basically contain differences between array
elements with shifted indices. As an example,
consider the updating formula</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">u2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>The vectorization consists of replacing the loop by arithmetics on
slices of arrays of length <tt class="docutils literal"><span class="pre">n-2</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>   <span class="c1"># alternative</span>
</pre></div>
</div>
<p>Note that the length of <tt class="docutils literal"><span class="pre">u2</span></tt> becomes <tt class="docutils literal"><span class="pre">n-2</span></tt>. If <tt class="docutils literal"><span class="pre">u2</span></tt> is already an array of
length <tt class="docutils literal"><span class="pre">n</span></tt> and we want to use the formula to update all the &#8220;inner&#8221;
elements of <tt class="docutils literal"><span class="pre">u2</span></tt>, as we will when solving a 1D wave equation, we can write</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">u2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>   <span class="c1"># alternative</span>
</pre></div>
</div>
<p>The first expression&#8217;s right-hand side is realized by the
following steps, involving temporary arrays with intermediate results,
since each array operation can only involve one or two arrays.
The <tt class="docutils literal"><span class="pre">numpy</span></tt> package performs (behind the scenes) the first line above in
four steps:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>temp1 = 2*u[1:-1]
temp2 = u[:-2] - temp1
temp3 = temp2 + u[2:]
u2[1:-1] = temp3
</pre></div>
</div>
<p>We need three temporary arrays, but a user does not need to worry about
such temporary arrays.</p>
<div class="admonition-common-mistakes-with-array-slices admonition">
<p class="first admonition-title">Common mistakes with array slices</p>
<p>Array expressions with slices demand that the slices have the same
shape. It easy to make a mistake in, e.g.,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>and write</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>Now <tt class="docutils literal"><span class="pre">u[1:n]</span></tt> has wrong length (<tt class="docutils literal"><span class="pre">n-1</span></tt>) compared to the other array
slices, causing a <tt class="docutils literal"><span class="pre">ValueError</span></tt> and the message
<tt class="docutils literal"><span class="pre">could</span> <span class="pre">not</span> <span class="pre">broadcast</span> <span class="pre">input</span> <span class="pre">array</span> <span class="pre">from</span> <span class="pre">shape</span> <span class="pre">103</span> <span class="pre">into</span> <span class="pre">shape</span> <span class="pre">104</span></tt>
(if <tt class="docutils literal"><span class="pre">n</span></tt> is 105). When such errors occur one must closely examine
all the slices. Usually, it is easier to get upper limits of slices
right when they use <tt class="docutils literal"><span class="pre">-1</span></tt> or <tt class="docutils literal"><span class="pre">-2</span></tt> or empty limit rather than
expressions involving the length.</p>
<p>Another common mistake, when <tt class="docutils literal"><span class="pre">u2</span></tt> has length <tt class="docutils literal"><span class="pre">n</span></tt>, is to forget the slice in the array on the
left-hand side,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p class="last">This is really crucial: now <tt class="docutils literal"><span class="pre">u2</span></tt> becomes a <em>new</em> array of length
<tt class="docutils literal"><span class="pre">n-2</span></tt>, which is the wrong length as we have no entries for the boundary
values. We meant to insert the right-hand side array <em>into</em> the
original <tt class="docutils literal"><span class="pre">u2</span></tt> array for the entries that correspond to the
internal points in the mesh (<tt class="docutils literal"><span class="pre">1:n-1</span></tt> or <tt class="docutils literal"><span class="pre">1:-1</span></tt>).</p>
</div>
<p>Vectorization may also work nicely with functions. To illustrate, we may
extend the previous example as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">u2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>Assuming <tt class="docutils literal"><span class="pre">u2</span></tt>, <tt class="docutils literal"><span class="pre">u</span></tt>, and <tt class="docutils literal"><span class="pre">x</span></tt> all have length <tt class="docutils literal"><span class="pre">n</span></tt>, the vectorized
version becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>Obviously, <tt class="docutils literal"><span class="pre">f</span></tt> must be able to take an array as argument for <tt class="docutils literal"><span class="pre">f(x[1:-1])</span></tt>
to make sense.</p>
</div>
<div class="section" id="finite-difference-schemes-expressed-as-slices">
<span id="wave-pde1-impl-vec-slices-fdm"></span><h2>Finite difference schemes expressed as slices<a class="headerlink" href="#finite-difference-schemes-expressed-as-slices" title="Permalink to this headline">¶</a></h2>
<p id="index-28">We now have the necessary tools to vectorize the wave equation
algorithm as described mathematically in the section <a class="reference internal" href="._main_wave001.html#wave-string-alg"><em>Formulating a recursive algorithm</em></a>
and through code in the section <a class="reference internal" href="#wave-pde1-impl-solver"><em>The solver function</em></a>.  There are
three loops: one for the initial condition, one for the first time
step, and finally the loop that is repeated for all subsequent time
levels. Since only the latter is repeated a potentially large number
of times, we limit our vectorization efforts to this loop. Within the time
loop, the space loop reads:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
    <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">u_nm1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
           <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_n</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>The vectorized version becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">u_nm1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
          <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_n</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">]</span><span class="o">-</span> <span class="n">u_nm1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">]</span> <span class="o">+</span> \
          <span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">u_n</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_n</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>The program
<a class="reference external" href="http://tinyurl.com/nu656p2/wave/wave1D/wave1D_u0v.py">wave1D_u0v.py</a>
contains a new version of the function <tt class="docutils literal"><span class="pre">solver</span></tt> where both the scalar
and the vectorized loops are included (the argument <tt class="docutils literal"><span class="pre">version</span></tt> is
set to <tt class="docutils literal"><span class="pre">scalar</span></tt> or <tt class="docutils literal"><span class="pre">vectorized</span></tt>, respectively).</p>
</div>
<div class="section" id="verification-2">
<span id="wave-pde1-impl-vec-verify-quadratic"></span><h2>Verification<a class="headerlink" href="#verification-2" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-29"></span><p id="index-30">We may reuse the quadratic solution <span class="math">\({u_{\small\mbox{e}}}(x,t)=x(L-x)(1+{\frac{1}{2}}t)\)</span> for
verifying also the vectorized code. A test function can now verify
both the scalar and the vectorized version. Moreover, we may
use a <tt class="docutils literal"><span class="pre">user_action</span></tt> function that compares the computed and exact
solution at each time level and performs a test:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_quadratic</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the scalar and vectorized versions for</span>
<span class="sd">    a quadratic u(x,t)=x(L-x)(1+t/2) that is exactly reproduced.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The following function must work for x as array or scalar</span>
    <span class="n">u_exact</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># f is a scalar (zeros_like(x) works for scalar x too)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Very coarse mesh for this exact test</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">Nx</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">def</span> <span class="nf">assert_no_error</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">u_exact</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-13</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;scalar&#39;</span><span class="p">)</span>
    <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
           <span class="n">user_action</span><span class="o">=</span><span class="n">assert_no_error</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;vectorized&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-lambda-functions admonition">
<p class="first admonition-title">Lambda functions</p>
<p>The code segment above demonstrates how to achieve very
compact code, without degraded readability,
by use of lambda functions for the various
input parameters that require a Python function. In essence,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
<p>is equivalent to</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
<p>Note that lambda functions can just contain a single expression and no
statements.</p>
<p>One advantage with lambda functions is that they can be used directly
in calls:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">L</span><span class="p">),</span> <span class="n">V</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="efficiency-measurements">
<h2>Efficiency measurements<a class="headerlink" href="#efficiency-measurements" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-31"></span><p id="index-32">The <tt class="docutils literal"><span class="pre">wave1D_u0v.py</span></tt> contains our new <tt class="docutils literal"><span class="pre">solver</span></tt> function with both
scalar and vectorized code. For comparing the efficiency
of scalar versus vectorized code, we need a <tt class="docutils literal"><span class="pre">viz</span></tt> function
as discussed in the section <a class="reference internal" href="#wave-pde1-impl-animate"><em>Visualization: animating the solution</em></a>.
All of this <tt class="docutils literal"><span class="pre">viz</span></tt> function can be reused, except the call
to <tt class="docutils literal"><span class="pre">solver_function</span></tt>. This call lacks the parameter
<tt class="docutils literal"><span class="pre">version</span></tt>, which we want to set to <tt class="docutils literal"><span class="pre">vectorized</span></tt> and <tt class="docutils literal"><span class="pre">scalar</span></tt>
for our efficiency measurements.</p>
<p>One solution is to copy the <tt class="docutils literal"><span class="pre">viz</span></tt> code from <tt class="docutils literal"><span class="pre">wave1D_u0</span></tt> into
<tt class="docutils literal"><span class="pre">wave1D_u0v.py</span></tt> and add a <tt class="docutils literal"><span class="pre">version</span></tt> argument to the <tt class="docutils literal"><span class="pre">solver_function</span></tt> call.
Taking into account how much animation code we
then duplicate, this is not a good idea.
Alternatively,
introducing the <tt class="docutils literal"><span class="pre">version</span></tt> argument in <tt class="docutils literal"><span class="pre">wave1D_u0.viz</span></tt>, so that this function
can be imported into <tt class="docutils literal"><span class="pre">wave1D_u0v.py</span></tt>, is not
a good solution either, since <tt class="docutils literal"><span class="pre">version</span></tt> has no meaning in that file.
We need better ideas!</p>
<div class="section" id="solution-1">
<h3>Solution 1<a class="headerlink" href="#solution-1" title="Permalink to this headline">¶</a></h3>
<p>Calling <tt class="docutils literal"><span class="pre">viz</span></tt> in <tt class="docutils literal"><span class="pre">wave1D_u0</span></tt> with <tt class="docutils literal"><span class="pre">solver_function</span></tt> as our new
solver in <tt class="docutils literal"><span class="pre">wave1D_u0v</span></tt> works fine, since this solver has
<tt class="docutils literal"><span class="pre">version='vectorized'</span></tt> as default value. The problem arises when we
want to test <tt class="docutils literal"><span class="pre">version='scalar'</span></tt>. The simplest solution is then
to use <tt class="docutils literal"><span class="pre">wave1D_u0.solver</span></tt> instead. We make a new <tt class="docutils literal"><span class="pre">viz</span></tt> function
in <tt class="docutils literal"><span class="pre">wave1D_u0v.py</span></tt> that has a <tt class="docutils literal"><span class="pre">version</span></tt> argument and that just
calls <tt class="docutils literal"><span class="pre">wave1D_u0.viz</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">viz</span><span class="p">(</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="c1"># PDE parameters</span>
    <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>               <span class="c1"># Interval for u in plots</span>
    <span class="n">animate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>             <span class="c1"># Simulation with animation?</span>
    <span class="n">tool</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span>        <span class="c1"># &#39;matplotlib&#39; or &#39;scitools&#39;</span>
    <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>   <span class="c1"># Function with numerical algorithm</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;vectorized&#39;</span><span class="p">,</span>     <span class="c1"># &#39;scalar&#39; or &#39;vectorized&#39;</span>
    <span class="p">):</span>
    <span class="kn">import</span> <span class="nn">wave1D_u0</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;vectorized&#39;</span><span class="p">:</span>
        <span class="c1"># Reuse viz from wave1D_u0, but with the present</span>
        <span class="c1"># modules&#39; new vectorized solver (which has</span>
        <span class="c1"># version=&#39;vectorized&#39; as default argument;</span>
        <span class="c1"># wave1D_u0.viz does not feature this argument)</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="n">wave1D_u0</span><span class="o">.</span><span class="n">viz</span><span class="p">(</span>
            <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
            <span class="n">animate</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">solver_function</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">:</span>
        <span class="c1"># Call wave1D_u0.viz with a solver with</span>
        <span class="c1"># scalar code and use wave1D_u0.solver.</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="n">wave1D_u0</span><span class="o">.</span><span class="n">viz</span><span class="p">(</span>
            <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
            <span class="n">animate</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span>
            <span class="n">solver_function</span><span class="o">=</span><span class="n">wave1D_u0</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="solution-2">
<h3>Solution 2<a class="headerlink" href="#solution-2" title="Permalink to this headline">¶</a></h3>
<p>There is a more advanced and fancier solution featuring a very useful trick:
we can make a new function that will always call <tt class="docutils literal"><span class="pre">wave1D_u0v.solver</span></tt>
with <tt class="docutils literal"><span class="pre">version='scalar'</span></tt>. The <tt class="docutils literal"><span class="pre">functools.partial</span></tt> function from
standard Python takes a function <tt class="docutils literal"><span class="pre">func</span></tt> as argument and
a series of positional and keyword arguments and returns a
new function that will call <tt class="docutils literal"><span class="pre">func</span></tt> with the supplied arguments,
while the user can control all the other arguments in <tt class="docutils literal"><span class="pre">func</span></tt>.
Consider a trivial example,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
<p>We want to ensure that <tt class="docutils literal"><span class="pre">f</span></tt> is always called with <tt class="docutils literal"><span class="pre">c=3</span></tt>, i.e., <tt class="docutils literal"><span class="pre">f</span></tt>
has only two &#8220;free&#8221; arguments <tt class="docutils literal"><span class="pre">a</span></tt> and <tt class="docutils literal"><span class="pre">b</span></tt>.
This functionality is obtained by</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">print</span> <span class="n">f2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># results in 1+2+3=6</span>
</pre></div>
</div>
<p>Now <tt class="docutils literal"><span class="pre">f2</span></tt> calls <tt class="docutils literal"><span class="pre">f</span></tt> with whatever the user supplies as <tt class="docutils literal"><span class="pre">a</span></tt> and <tt class="docutils literal"><span class="pre">b</span></tt>,
but <tt class="docutils literal"><span class="pre">c</span></tt> is always <tt class="docutils literal"><span class="pre">3</span></tt>.</p>
<p>Back to our <tt class="docutils literal"><span class="pre">viz</span></tt> code, we can do</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="c1"># Call wave1D_u0.solver with version fixed to scalar</span>
<span class="n">scalar_solver</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">wave1D_u0</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;scalar&#39;</span><span class="p">)</span>
<span class="n">cpu</span> <span class="o">=</span> <span class="n">wave1D_u0</span><span class="o">.</span><span class="n">viz</span><span class="p">(</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">umin</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span>
        <span class="n">animate</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">solver_function</span><span class="o">=</span><span class="n">scalar_solver</span><span class="p">)</span>
</pre></div>
</div>
<p>The new <tt class="docutils literal"><span class="pre">scalar_solver</span></tt> takes the same arguments as
<tt class="docutils literal"><span class="pre">wave1D_u0.scalar</span></tt> and calls <tt class="docutils literal"><span class="pre">wave1D_u0v.scalar</span></tt>,
but always supplies the extra argument
<tt class="docutils literal"><span class="pre">version='scalar'</span></tt>. When sending this <tt class="docutils literal"><span class="pre">solver_function</span></tt>
to <tt class="docutils literal"><span class="pre">wave1D_u0.viz</span></tt>, the latter will call <tt class="docutils literal"><span class="pre">wave1D_u0v.solver</span></tt>
with all the <tt class="docutils literal"><span class="pre">I</span></tt>, <tt class="docutils literal"><span class="pre">V</span></tt>, <tt class="docutils literal"><span class="pre">f</span></tt>, etc., arguments we supply, plus
<tt class="docutils literal"><span class="pre">version='scalar'</span></tt>.</p>
</div>
<div class="section" id="efficiency-experiments">
<h3>Efficiency experiments<a class="headerlink" href="#efficiency-experiments" title="Permalink to this headline">¶</a></h3>
<p>We now have a <tt class="docutils literal"><span class="pre">viz</span></tt> function that can call our solver function both in
scalar and vectorized mode. The function <tt class="docutils literal"><span class="pre">run_efficiency_experiments</span></tt>
in <tt class="docutils literal"><span class="pre">wave1D_u0v.py</span></tt> performs a set of experiments and reports the
CPU time spent in the scalar and vectorized solver for
the previous string vibration example with spatial mesh resolutions
<span class="math">\(N_x=50,100,200,400,800\)</span>. Running this function reveals
that the vectorized
code runs substantially faster: the vectorized code runs approximately
<span class="math">\(N_x/10\)</span> times as fast as the scalar code!</p>
</div>
</div>
<div class="section" id="remark-on-the-updating-of-arrays">
<span id="wave-pde1-impl-ref-switch"></span><h2>Remark on the updating of arrays<a class="headerlink" href="#remark-on-the-updating-of-arrays" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-33"></span><p id="index-34">At the end of each time step we need to update the <tt class="docutils literal"><span class="pre">u_nm1</span></tt> and <tt class="docutils literal"><span class="pre">u_n</span></tt>
arrays such that they have the right content for the next time step:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u_nm1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u_n</span>
<span class="n">u_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span>
</pre></div>
</div>
<p>The order here is important: updating <tt class="docutils literal"><span class="pre">u_n</span></tt> first, makes <tt class="docutils literal"><span class="pre">u_nm1</span></tt> equal
to <tt class="docutils literal"><span class="pre">u</span></tt>, which is wrong!</p>
<p>The assignment <tt class="docutils literal"><span class="pre">u_n[:]</span> <span class="pre">=</span> <span class="pre">u</span></tt> copies the content of the <tt class="docutils literal"><span class="pre">u</span></tt> array into
the elements of the <tt class="docutils literal"><span class="pre">u_n</span></tt> array. Such copying takes time, but
that time is negligible compared to the time needed for
computing <tt class="docutils literal"><span class="pre">u</span></tt> from the finite difference formula,
even when the formula has a vectorized implementation.
However, efficiency of program code is a key topic when solving
PDEs numerically (particularly when there are two or three
space dimensions), so it must be mentioned that there exists a
much more efficient way of making the arrays <tt class="docutils literal"><span class="pre">u_nm1</span></tt> and <tt class="docutils literal"><span class="pre">u_n</span></tt>
ready for the next time step. The idea is based on <em>switching
references</em> and explained as follows.</p>
<p>A Python variable is actually a reference to some object (C programmers
may think of pointers). Instead of copying data, we can let <tt class="docutils literal"><span class="pre">u_nm1</span></tt>
refer to the <tt class="docutils literal"><span class="pre">u_n</span></tt> object and <tt class="docutils literal"><span class="pre">u_n</span></tt> refer to the <tt class="docutils literal"><span class="pre">u</span></tt> object.
This is a very efficient operation (like switching pointers in C).
A naive implementation like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u_nm1</span> <span class="o">=</span> <span class="n">u_n</span>
<span class="n">u_n</span> <span class="o">=</span> <span class="n">u</span>
</pre></div>
</div>
<p>will fail, however, because now <tt class="docutils literal"><span class="pre">u_nm1</span></tt> refers to the <tt class="docutils literal"><span class="pre">u_n</span></tt> object,
but then the name <tt class="docutils literal"><span class="pre">u_n</span></tt> refers to <tt class="docutils literal"><span class="pre">u</span></tt>, so that this <tt class="docutils literal"><span class="pre">u</span></tt> object
has two references, <tt class="docutils literal"><span class="pre">u_n</span></tt> and <tt class="docutils literal"><span class="pre">u</span></tt>, while our third array, originally
referred to by <tt class="docutils literal"><span class="pre">u_nm1</span></tt>, has no more references and is lost.
This means that the variables <tt class="docutils literal"><span class="pre">u</span></tt>, <tt class="docutils literal"><span class="pre">u_n</span></tt>, and <tt class="docutils literal"><span class="pre">u_nm1</span></tt> refer to two
arrays and not three. Consequently, the computations at the next
time level will be messed up, since updating the elements in
<tt class="docutils literal"><span class="pre">u</span></tt> will imply updating the elements in <tt class="docutils literal"><span class="pre">u_n</span></tt> too, thereby destroying
the solution at the previous time step.</p>
<p>While <tt class="docutils literal"><span class="pre">u_nm1</span> <span class="pre">=</span> <span class="pre">u_n</span></tt> is fine, <tt class="docutils literal"><span class="pre">u_n</span> <span class="pre">=</span> <span class="pre">u</span></tt> is problematic, so
the solution to this problem is to ensure that <tt class="docutils literal"><span class="pre">u</span></tt>
points to the <tt class="docutils literal"><span class="pre">u_nm1</span></tt> array. This is mathematically wrong, but
new correct values will be filled into <tt class="docutils literal"><span class="pre">u</span></tt> at the next time step
and make it right.</p>
<p>The correct switch of references is</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">u_nm1</span>
<span class="n">u_nm1</span> <span class="o">=</span> <span class="n">u_n</span>
<span class="n">u_n</span> <span class="o">=</span> <span class="n">u</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">tmp</span>
</pre></div>
</div>
<p>We can get rid of the temporary reference <tt class="docutils literal"><span class="pre">tmp</span></tt> by writing</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">u_nm1</span><span class="p">,</span> <span class="n">u_n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">u_n</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nm1</span>
</pre></div>
</div>
<p>This switching of references for updating our arrays
will be used in later implementations.</p>
<div class="admonition-caution admonition">
<p class="first admonition-title">Caution</p>
<p class="last">The update <tt class="docutils literal"><span class="pre">u_nm1,</span> <span class="pre">u_n,</span> <span class="pre">u</span> <span class="pre">=</span> <span class="pre">u_n,</span> <span class="pre">u,</span> <span class="pre">u_nm1</span></tt> leaves wrong content in <tt class="docutils literal"><span class="pre">u</span></tt>
at the final time step. This means that if we return <tt class="docutils literal"><span class="pre">u</span></tt>, as we
do in the example codes here, we actually return <tt class="docutils literal"><span class="pre">u_nm1</span></tt>, which is
obviously wrong. It is therefore important to adjust the content
of <tt class="docutils literal"><span class="pre">u</span></tt> to <tt class="docutils literal"><span class="pre">u</span> <span class="pre">=</span> <span class="pre">u_n</span></tt> before returning <tt class="docutils literal"><span class="pre">u</span></tt>. (Note that
the <tt class="docutils literal"><span class="pre">user_action</span></tt> function
reduces the need to return the solution from the solver.)</p>
</div>
</div>
</div>
<div class="section" id="exercises-1">
<h1>Exercises<a class="headerlink" href="#exercises-1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="exercise-1-simulate-a-standing-wave">
<span id="wave-exer-standingwave"></span><h2>Exercise 1: Simulate a standing wave<a class="headerlink" href="#exercise-1-simulate-a-standing-wave" title="Permalink to this headline">¶</a></h2>
<p>The purpose of this exercise is to simulate standing waves on <span class="math">\([0,L]\)</span>
and illustrate the error in the simulation.
Standing waves arise from an initial condition</p>
<div class="math">
\[u(x,0)= A \sin\left(\frac{\pi}{L}mx\right),\]</div>
<p>where <span class="math">\(m\)</span> is an integer and <span class="math">\(A\)</span> is a freely chosen amplitude.
The corresponding exact solution can be computed and reads</p>
<div class="math">
\[{u_{\small\mbox{e}}}(x,t) =  A\sin\left(\frac{\pi}{L}mx\right)
\cos\left(\frac{\pi}{L}mct\right){\thinspace .}\]</div>
<p><strong>a)</strong>
Explain that for a function <span class="math">\(\sin kx\cos \omega t\)</span> the wave length
in space is <span class="math">\(\lambda = 2\pi /k\)</span> and the period in time is <span class="math">\(P=2\pi/\omega\)</span>.
Use these expressions to find the wave length in space and period in
time of <span class="math">\({u_{\small\mbox{e}}}\)</span> above.</p>
<p><strong>b)</strong>
Import the <tt class="docutils literal"><span class="pre">solver</span></tt> function from <tt class="docutils literal"><span class="pre">wave1D_u0.py</span></tt> into a new file
where the <tt class="docutils literal"><span class="pre">viz</span></tt> function is reimplemented such that it
plots either the numerical <em>and</em> the exact solution, <em>or</em> the error.</p>
<p><strong>c)</strong>
Make animations where you illustrate how the error
<span class="math">\(e^n_i ={u_{\small\mbox{e}}}(x_i, t_n)- u^n_i\)</span>
develops and increases in time. Also make animations of
<span class="math">\(u\)</span> and <span class="math">\({u_{\small\mbox{e}}}\)</span> simultaneously.</p>
<p><strong>Hint 1.</strong>
Quite long time simulations are needed in order to display significant
discrepancies between the numerical and exact solution.</p>
<p><strong>Hint 2.</strong>
A possible set of parameters is <span class="math">\(L=12\)</span>, <span class="math">\(m=9\)</span>, <span class="math">\(c=2\)</span>, <span class="math">\(A=1\)</span>, <span class="math">\(N_x=80\)</span>,
<span class="math">\(C=0.8\)</span>. The error mesh function <span class="math">\(e^n\)</span> can be simulated for 10 periods,
while 20-30 periods are needed to show significant differences between
the curves for the numerical and exact solution.</p>
<p>Filename: <tt class="docutils literal"><span class="pre">wave_standing</span></tt>.</p>
<div class="section" id="remarks-1">
<h3>Remarks<a class="headerlink" href="#remarks-1" title="Permalink to this headline">¶</a></h3>
<p>The important
parameters for numerical quality are <span class="math">\(C\)</span> and <span class="math">\(k\Delta x\)</span>, where
<span class="math">\(C=c\Delta t/\Delta x\)</span> is the Courant number and <span class="math">\(k\)</span> is defined above
(<span class="math">\(k\Delta x\)</span> is proportional to how many mesh points we have per wave length
in space, see the section <a class="reference internal" href="._main_wave004.html#wave-pde1-num-dispersion"><em>Numerical dispersion relation</em></a> for explanation).</p>
</div>
</div>
<div class="section" id="exercise-2-add-storage-of-solution-in-a-user-action-function">
<span id="wave-exer-store-list"></span><h2>Exercise 2: Add storage of solution in a user action function<a class="headerlink" href="#exercise-2-add-storage-of-solution-in-a-user-action-function" title="Permalink to this headline">¶</a></h2>
<p>Extend the <tt class="docutils literal"><span class="pre">plot_u</span></tt> function in the file <tt class="docutils literal"><span class="pre">wave1D_u0.py</span></tt> to also store
the solutions <tt class="docutils literal"><span class="pre">u</span></tt> in a list.
To this end, declare <tt class="docutils literal"><span class="pre">all_u</span></tt> as
an empty list in the <tt class="docutils literal"><span class="pre">viz</span></tt> function, outside <tt class="docutils literal"><span class="pre">plot_u</span></tt>, and perform
an append operation inside the <tt class="docutils literal"><span class="pre">plot_u</span></tt> function. Note that a
function, like <tt class="docutils literal"><span class="pre">plot_u</span></tt>, inside another function, like <tt class="docutils literal"><span class="pre">viz</span></tt>,
remembers all local variables in <tt class="docutils literal"><span class="pre">viz</span></tt> function, including <tt class="docutils literal"><span class="pre">all_u</span></tt>,
even when <tt class="docutils literal"><span class="pre">plot_u</span></tt> is called (as <tt class="docutils literal"><span class="pre">user_action</span></tt>) in the <tt class="docutils literal"><span class="pre">solver</span></tt> function.
Test both <tt class="docutils literal"><span class="pre">all_u.append(u)</span></tt> and <tt class="docutils literal"><span class="pre">all_u.append(u.copy())</span></tt>.
Why does one of these constructions fail to store the solution correctly?
Let the <tt class="docutils literal"><span class="pre">viz</span></tt> function return the <tt class="docutils literal"><span class="pre">all_u</span></tt> list
converted to a two-dimensional <tt class="docutils literal"><span class="pre">numpy</span></tt> array.</p>
<p>Filename: <tt class="docutils literal"><span class="pre">wave1D_u0_s_store</span></tt>.</p>
</div>
<div class="section" id="exercise-3-use-a-class-for-the-user-action-function">
<span id="wave-exer-store-list-class"></span><h2>Exercise 3: Use a class for the user action function<a class="headerlink" href="#exercise-3-use-a-class-for-the-user-action-function" title="Permalink to this headline">¶</a></h2>
<p>Redo <a class="reference internal" href="#wave-exer-store-list"><em>Exercise 2: Add storage of solution in a user action function</em></a> using a class for the user
action function. Let the <tt class="docutils literal"><span class="pre">all_u</span></tt> list be an attribute in this class
and implement the user action function as a method (the special method
<tt class="docutils literal"><span class="pre">__call__</span></tt> is a natural choice). The class versions avoid that the
user action function depends on parameters defined outside the
function (such as <tt class="docutils literal"><span class="pre">all_u</span></tt> in <a class="reference internal" href="#wave-exer-store-list"><em>Exercise 2: Add storage of solution in a user action function</em></a>).</p>
<p>Filename: <tt class="docutils literal"><span class="pre">wave1D_u0_s2c</span></tt>.</p>
</div>
<div class="section" id="exercise-4-compare-several-courant-numbers-in-one-movie">
<span id="wave-exer-multiple-c"></span><h2>Exercise 4: Compare several Courant numbers in one movie<a class="headerlink" href="#exercise-4-compare-several-courant-numbers-in-one-movie" title="Permalink to this headline">¶</a></h2>
<p>The goal of this exercise is to make movies where several curves,
corresponding to different Courant numbers, are visualized. Write a
program that resembles <tt class="docutils literal"><span class="pre">wave1D_u0_s2c.py</span></tt> in <a class="reference internal" href="#wave-exer-store-list-class"><em>Exercise 3: Use a class for the user action function</em></a>, but with a <tt class="docutils literal"><span class="pre">viz</span></tt> function that
can take a list of <tt class="docutils literal"><span class="pre">C</span></tt> values as argument and create a movie with
solutions corresponding to the given <tt class="docutils literal"><span class="pre">C</span></tt> values. The <tt class="docutils literal"><span class="pre">plot_u</span></tt> function
must be changed to store the solution in an array (see <a class="reference internal" href="#wave-exer-store-list"><em>Exercise 2: Add storage of solution in a user action function</em></a> or <a class="reference internal" href="#wave-exer-store-list-class"><em>Exercise 3: Use a class for the user action function</em></a> for
details), <tt class="docutils literal"><span class="pre">solver</span></tt> must be computed for each value of the Courant
number, and finally one must run through each time step and plot all
the spatial solution curves in one figure and store it in a file.</p>
<p>The challenge in such a visualization is to ensure that the curves in
one plot correspond to the same time point. The easiest remedy is to
keep the time resolution constant and change the space resolution
to change the Courant number. Note that each spatial grid is needed for
the final plotting, so it is an option to store those grids too.</p>
<p>Filename: <tt class="docutils literal"><span class="pre">wave_numerics_comparison</span></tt>.</p>
</div>
<div class="section" id="exercise-5-implementing-the-solver-function-as-a-generator">
<span id="wave-exer-useraction-generator"></span><h2>Exercise 5: Implementing the solver function as a generator<a class="headerlink" href="#exercise-5-implementing-the-solver-function-as-a-generator" title="Permalink to this headline">¶</a></h2>
<p>The callback function <tt class="docutils literal"><span class="pre">user_action(u,</span> <span class="pre">x,</span> <span class="pre">t,</span> <span class="pre">n)</span></tt> is called from the
<tt class="docutils literal"><span class="pre">solver</span></tt> function (in, e.g., <tt class="docutils literal"><span class="pre">wave1D_u0.py</span></tt>) at every time level and lets
the user work perform desired actions with the solution, like plotting it
on the screen. We have implemented the callback function in the typical
way it would have been done in C and Fortran. Specifically, the code looks
like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">user_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">user_action</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">break</span>
</pre></div>
</div>
<p>Many Python programmers, however, may claim that <tt class="docutils literal"><span class="pre">solver</span></tt> is an iterative
process, and that iterative processes with callbacks to the user code is
more elegantly implemented as <em>generators</em>. The rest of the text has little
meaning unless you are familiar with Python generators and the <tt class="docutils literal"><span class="pre">yield</span></tt>
statement.</p>
<p>Instead of calling <tt class="docutils literal"><span class="pre">user_action</span></tt>, the <tt class="docutils literal"><span class="pre">solver</span></tt> function
issues a <tt class="docutils literal"><span class="pre">yield</span></tt> statement, which is a kind of <tt class="docutils literal"><span class="pre">return</span></tt> statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">yield</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span>
</pre></div>
</div>
<p>The program control is directed back to the calling code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># Do something with u at t[n]</span>
</pre></div>
</div>
<p>When the block is done, <tt class="docutils literal"><span class="pre">solver</span></tt> continues with the statement after <tt class="docutils literal"><span class="pre">yield</span></tt>.
Note that the functionality of terminating the solution process if
<tt class="docutils literal"><span class="pre">user_action</span></tt> returns a <tt class="docutils literal"><span class="pre">True</span></tt> value is not possible to implement in the
generator case.</p>
<p>Implement the <tt class="docutils literal"><span class="pre">solver</span></tt> function as a generator, and plot the solution
at each time step.
Filename: <tt class="docutils literal"><span class="pre">wave1D_u0_generator</span></tt>.</p>
</div>
<div class="section" id="project-6-calculus-with-1d-mesh-functions">
<span id="wave-exer-mesh1d-calculus"></span><h2>Project 6: Calculus with 1D mesh functions<a class="headerlink" href="#project-6-calculus-with-1d-mesh-functions" title="Permalink to this headline">¶</a></h2>
<p>This project explores integration and differentiation of
mesh functions, both with scalar and vectorized implementations.
We are given a mesh function <span class="math">\(f_i\)</span> on a spatial one-dimensional
mesh <span class="math">\(x_i=i\Delta x\)</span>, <span class="math">\(i=0,\ldots,N_x\)</span>, over the interval <span class="math">\([a,b]\)</span>.</p>
<p><strong>a)</strong>
Define the discrete derivative of <span class="math">\(f_i\)</span> by using centered
differences at internal mesh points and one-sided differences
at the end points. Implement a scalar version of
the computation in a Python function and write an associated unit test
for the linear case <span class="math">\(f(x)=4x-2.5\)</span> where the discrete derivative should
be exact.</p>
<p><strong>b)</strong>
Vectorize the implementation of the discrete derivative.
Extend the unit test to check the validity of the implementation.</p>
<p><strong>c)</strong>
To compute the discrete integral <span class="math">\(F_i\)</span> of <span class="math">\(f_i\)</span>, we assume that
the mesh function <span class="math">\(f_i\)</span> varies linearly between the mesh points.
Let <span class="math">\(f(x)\)</span> be such a linear interpolant of <span class="math">\(f_i\)</span>. We then
have</p>
<div class="math">
\[F_i = \int_{x_0}^{x_i} f(x) dx{\thinspace .}\]</div>
<p>The exact integral of a piecewise linear function <span class="math">\(f(x)\)</span> is
given by the Trapezoidal rule. Show
that if <span class="math">\(F_{i}\)</span> is already computed, we can find <span class="math">\(F_{i+1}\)</span>
from</p>
<div class="math">
\[F_{i+1} = F_i + \frac{1}{2}(f_i + f_{i+1})\Delta x{\thinspace .}\]</div>
<p>Make a function for the scalar implementation of the discrete integral
as a mesh function. That is, the function should return
<span class="math">\(F_i\)</span> for <span class="math">\(i=0,\ldots,N_x\)</span>.
For a unit test one can use the fact that the above defined
discrete integral of a linear
function (say <span class="math">\(f(x)=4x-2.5\)</span>) is exact.</p>
<p><strong>d)</strong>
Vectorize the implementation of the discrete integral.
Extend the unit test to check the validity of the implementation.</p>
<p><strong>Hint.</strong>
Interpret the recursive formula for <span class="math">\(F_{i+1}\)</span> as a sum.
Make an array with each element of the sum and use the &#8220;cumsum&#8221;
(<tt class="docutils literal"><span class="pre">numpy.cumsum</span></tt>) operation to compute the accumulative sum:
<tt class="docutils literal"><span class="pre">numpy.cumsum([1,3,5])</span></tt> is <tt class="docutils literal"><span class="pre">[1,4,9]</span></tt>.</p>
<p><strong>e)</strong>
Create a class <tt class="docutils literal"><span class="pre">MeshCalculus</span></tt> that can integrate and differentiate
mesh functions. The class can just define some methods that call
the previously implemented Python functions. Here is an example
on the usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>        <span class="c1"># mesh</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                    <span class="c1"># mesh function</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>    <span class="c1"># discrete derivative</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>         <span class="c1"># discrete anti-derivative</span>
</pre></div>
</div>
<p><strong>Solution.</strong>
The final version of the code reads</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Calculus with a 1D mesh function.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">MeshCalculus</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span> <span class="o">=</span> <span class="n">vectorized</span>

    <span class="k">def</span> <span class="nf">differentiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the derivative of f by centered differences, but</span>
<span class="sd">        forw and back difference at the start and end, respectively.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>     <span class="c1"># number of spatial steps</span>
        <span class="n">num_dfdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compute approximate derivatives at end-points first</span>
        <span class="n">num_dfdx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="n">dx</span>          <span class="c1"># FD approx.</span>
        <span class="n">num_dfdx</span><span class="p">[</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">Nx</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="n">dx</span>     <span class="c1"># BD approx.</span>
        <span class="c1"># proceed with approximate derivatives for inner mesh points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span><span class="p">:</span>
            <span class="n">num_dfdx</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># scalar version</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
                <span class="n">num_dfdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_dfdx</span>

    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the integral of f(x) over the interval</span>
<span class="sd">        covered by x.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># starting value for iterative scheme</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorized</span><span class="p">:</span>
            <span class="n">all_trapezoids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">all_trapezoids</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">*</span><span class="n">dx</span>
            <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">all_trapezoids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># scalar version</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">dx</span>
        <span class="k">return</span> <span class="n">F</span>

<span class="k">def</span> <span class="nf">test_differentiate</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.5</span>
    <span class="k">def</span> <span class="nf">dfdx</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">derivatives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">derivatives</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">derivatives</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">Nx</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">exact_dfdx</span> <span class="o">=</span> <span class="n">dfdx</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>        <span class="c1"># compute exact derivatives</span>
    <span class="c1"># test vectorized version</span>
    <span class="n">calc_v</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">num_dfdx</span>  <span class="o">=</span> <span class="n">calc_v</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="c1"># test scalar version</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">num_dfdx</span>  <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">differentiate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num_dfdx</span> <span class="o">-</span> <span class="n">exact_dfdx</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>

<span class="k">def</span> <span class="nf">test_integrate</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.5</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">Nx</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1">#    a = 2.5/4; b = 10; Nx = 2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># The exact integral amounts to the total area of two triangles</span>
    <span class="n">I_exact</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="mf">2.5</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># test vectorized version</span>
    <span class="n">calc_v</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">calc_v</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">F</span><span class="p">,</span> <span class="n">I_exact</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I_exact</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">diff</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="c1"># test scalar version</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">MeshCalculus</span><span class="p">(</span><span class="n">vectorized</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">F</span><span class="p">,</span> <span class="n">I_exact</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I_exact</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">diff</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test_differentiate</span><span class="p">()</span>
    <span class="n">test_integrate</span><span class="p">()</span>
</pre></div>
</div>
<p>Filename: <tt class="docutils literal"><span class="pre">mesh_calculus_1D</span></tt>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Implementation</a><ul>
<li><a class="reference internal" href="#callback-function-for-user-specific-actions">Callback function for user-specific actions</a></li>
<li><a class="reference internal" href="#the-solver-function">The solver function</a></li>
<li><a class="reference internal" href="#verification-exact-quadratic-solution">Verification: exact quadratic solution</a></li>
<li><a class="reference internal" href="#verification-convergence-rates">Verification: convergence rates</a></li>
<li><a class="reference internal" href="#visualization-animating-the-solution">Visualization: animating the solution</a><ul>
<li><a class="reference internal" href="#function-for-administering-the-simulation">Function for administering the simulation</a></li>
<li><a class="reference internal" href="#dissection-of-the-code">Dissection of the code</a></li>
<li><a class="reference internal" href="#making-movie-files">Making movie files</a></li>
<li><a class="reference internal" href="#skipping-frames-for-animation-speed">Skipping frames for animation speed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-a-case">Running a case</a></li>
<li><a class="reference internal" href="#working-with-a-scaled-pde-model">Working with a scaled PDE model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vectorization">Vectorization</a><ul>
<li><a class="reference internal" href="#operations-on-slices-of-arrays">Operations on slices of arrays</a></li>
<li><a class="reference internal" href="#finite-difference-schemes-expressed-as-slices">Finite difference schemes expressed as slices</a></li>
<li><a class="reference internal" href="#verification-2">Verification</a></li>
<li><a class="reference internal" href="#efficiency-measurements">Efficiency measurements</a><ul>
<li><a class="reference internal" href="#solution-1">Solution 1</a></li>
<li><a class="reference internal" href="#solution-2">Solution 2</a></li>
<li><a class="reference internal" href="#efficiency-experiments">Efficiency experiments</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remark-on-the-updating-of-arrays">Remark on the updating of arrays</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises-1">Exercises</a><ul>
<li><a class="reference internal" href="#exercise-1-simulate-a-standing-wave">Exercise 1: Simulate a standing wave</a><ul>
<li><a class="reference internal" href="#remarks-1">Remarks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-2-add-storage-of-solution-in-a-user-action-function">Exercise 2: Add storage of solution in a user action function</a></li>
<li><a class="reference internal" href="#exercise-3-use-a-class-for-the-user-action-function">Exercise 3: Use a class for the user action function</a></li>
<li><a class="reference internal" href="#exercise-4-compare-several-courant-numbers-in-one-movie">Exercise 4: Compare several Courant numbers in one movie</a></li>
<li><a class="reference internal" href="#exercise-5-implementing-the-solver-function-as-a-generator">Exercise 5: Implementing the solver function as a generator</a></li>
<li><a class="reference internal" href="#project-6-calculus-with-1d-mesh-functions">Project 6: Calculus with 1D mesh functions</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._main_wave001.html"
                        title="previous chapter">Simulation of waves on a string</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._main_wave003.html"
                        title="next chapter">Generalization: reflecting boundaries</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._main_wave002.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._main_wave003.html" title="Generalization: reflecting boundaries"
             >next</a> |</li>
        <li class="right" >
          <a href="._main_wave001.html" title="Simulation of waves on a string"
             >previous</a> |</li>
        <li><a href="index.html">Finite difference methods for wave equations</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
    <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
    <br />
    <br />
      &copy;2017, Hans Petter Langtangen, Svein Linge. Released under CC Attribution 4.0 license.
  </div>
</div>

  </body>
</html>